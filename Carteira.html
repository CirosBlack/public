<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Balanceamento de Carteira (com IA)</title>
    <!-- Chart.js e plugin de datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        /* Estilos Gerais */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            justify-content: center;
            padding: 10px;
            margin: 0;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 1500px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            text-align: center;
            color: #2c3e50;
        }
        /* Tabela Responsiva */
        .table-container {
            width: 100%;
            overflow-x: auto; /* Adiciona scroll horizontal APENAS na tabela se necess√°rio */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #dfe6e9;
            padding: 12px 8px; /* Padding reduzido para ajudar no encaixe */
            text-align: center;
            font-size: 14px;
            /* white-space: nowrap; Removido para permitir quebra de linha */
        }
        th {
            background-color: #34495e;
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        input[type="number"], input[type="text"], select {
            width: 90%;
            padding: 8px;
            border: 1px solid #b2bec3;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            min-width: 70px;
            box-sizing: border-box;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #c0392b;
        }
        /* PAINEL DE CONTROLO (DASHBOARD) */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        .dashboard-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .dashboard-card label {
            font-size: 14px;
            color: #7f8c8d;
            display: block;
            margin-bottom: 8px;
        }
        .dashboard-card .value, .dashboard-card input {
            font-size: 22px;
            font-weight: bold;
            color: #2c3e50;
        }
        .dashboard-card input {
            width: 100%;
            box-sizing: border-box;
            border: none;
            background: transparent;
            padding: 0;
        }
        #targetPctTotal.invalid {
            color: #c0392b;
        }

        .output { font-weight: bold; }
        .status-aportar { color: #27ae60; }
        .status-aguardar { color: #7f8c8d; }
        .priority-alta { background-color: #f8d7da; color: #721c24; font-weight: bold; }
        .priority-media { background-color: #fff3cd; color: #856404; font-weight: bold; }
        .priority-baixa { background-color: #d4edda; color: #155724; font-weight: bold; }
        .priority-nenhuma { background-color: #e9ecef; color: #495057; }
        
        /* Gerenciamento de Ativos (Bot√µes) */
        .asset-management {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .asset-management button, .modal-button, .action-btn {
            background-color: #34495e;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
            text-decoration: none;
        }
        .asset-management button:hover { background-color: #4a627a; }
        .action-btn {
             padding: 5px 12px;
        }
        .search-btn {
            background-color: #2980b9;
        }
        .search-btn:hover {
            background-color: #3498db;
        }
        #aiAnalysisBtn, #aiSuggestBtn {
            background-color: #8e44ad;
        }
        #aiAnalysisBtn:hover, #aiSuggestBtn:hover {
            background-color: #9b59b6;
        }

        /* Gr√°ficos */
        .charts-header {
            text-align: center;
            margin-top: 30px;
        }
        .charts-header select {
            padding: 8px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #dfe6e9;
        }
        .charts-container {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .chart-wrapper {
            width: 100%;
            max-width: 450px; /* Tamanho m√°ximo dos gr√°ficos */
            margin: 0 auto;
        }

        /* Estilos do Modal (Pop-up) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #aiResult {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            text-align: left;
            border: 1px solid #dfe6e9;
        }
        .modal-form-group {
            display: flex;
            flex-direction: column;
        }
        .modal-form-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .modal-form-group input {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        .modal-button.confirm { background-color: #27ae60; }
        .modal-button.confirm:hover { background-color: #2ecc71; }
        .modal-button.cancel { background-color: #7f8c8d; }
        .modal-button.cancel:hover { background-color: #95a5a6; }

        /* Media Queries para Responsividade */
        @media (max-width: 992px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 576px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .chart-wrapper {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Calculadora de Balanceamento de Carteira</h1>

        <!-- NOVO DASHBOARD -->
        <div class="dashboard">
            <div class="dashboard-card">
                <label>üí∞ Patrim√¥nio Total</label>
                <span id="totalPatrimonioTop" class="value">R$ 0,00</span>
            </div>
            <div class="dashboard-card">
                <label>üíµ Renda Mensal (Est.)</label>
                <span id="monthlyDividends" class="value">R$ 0,00</span>
            </div>
            <div class="dashboard-card">
                <label>üéØ Soma % Alvo</label>
                <span id="targetPctTotal" class="value">100.00%</span>
            </div>
            <div class="dashboard-card">
                <label>üí∏ Aporte Mensal (R$)</label>
                <input type="number" id="aporteMensal" value="500" step="50" oninput="calculatePortfolio()">
            </div>
            <div class="dashboard-card">
                <label>üìà Total a Investir</label>
                <span id="totalAporteReal" class="value">R$ 0,00</span>
            </div>
             <div class="dashboard-card">
                <label>üì¶ Total de Cotas</label>
                <span id="totalCotasComprar" class="value">0</span>
            </div>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Ativo</th>
                        <th>Segmento</th>
                        <th>% Alvo</th>
                        <th>Minha Qtd.</th>
                        <th>Pre√ßo Atual (R$)</th>
                        <th>DY (12M) %</th>
                        <th>A√ß√µes</th>
                        <th>Meu Valor (R$)</th>
                        <th>Dividendo Mensal (Est.)</th>
                        <th>% Atual</th>
                        <th>Dist√¢ncia (R$)</th>
                        <th>Status</th>
                        <th>Prioridade</th>
                        <th>Cotas a Comprar</th>
                        <th>Valor das Cotas (R$)</th>
                    </tr>
                </thead>
                <tbody id="portfolio-body"></tbody>
            </table>
        </div>

        <div class="asset-management">
            <button id="addAssetBtn">Adicionar Novo Ativo</button>
            <button id="removeAssetBtn">Remover Ativo</button>
            <button id="aiAnalysisBtn">‚ú® Analisar Carteira com IA</button>
            <button id="aiSuggestBtn">‚ú® Sugerir Novo Ativo com IA</button>
        </div>

        <div class="charts-header">
            <h3>Visualiza√ß√£o da Carteira</h3>
            <select id="chartTypeSelector" onchange="changeChartType()">
                <option value="doughnut">Rosca</option>
                <option value="pie">Pizza</option>
                <option value="barVertical">Barras (Vertical)</option>
                <option value="bar">Barras (Horizontal)</option>
                <option value="polarArea">√Årea Polar</option>
            </select>
        </div>

        <div class="charts-container">
            <div class="chart-wrapper">
                <canvas id="targetAllocationChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <canvas id="currentAllocationChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <div id="addAssetModal" class="modal">
        <div class="modal-content">
            <h3>Adicionar Novo Ativo</h3>
            <form id="addAssetForm">
                <div class="modal-form-group">
                    <label for="newAssetName">Nome do Ativo (ex: ITSA4)</label>
                    <input type="text" id="newAssetName" required>
                </div>
                <div class="modal-form-group">
                    <label for="newAssetSegment">Segmento (ex: A√ß√µes, FII)</label>
                    <input type="text" id="newAssetSegment" required>
                </div>
                <div class="modal-form-group">
                    <label for="newAssetTargetPct">% Alvo (apenas o n√∫mero)</label>
                    <input type="number" id="newAssetTargetPct" step="0.1" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="modal-button cancel" id="cancelAdd">Cancelar</button>
                    <button type="submit" class="modal-button confirm">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="removeAssetModal" class="modal">
        <div class="modal-content">
            <h3>Remover Ativo</h3>
            <form id="removeAssetForm">
                <div class="modal-form-group">
                    <label for="removeAssetName">Digite o nome do ativo a ser removido</label>
                    <input type="text" id="removeAssetName" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="modal-button cancel" id="cancelRemove">Cancelar</button>
                    <button type="submit" class="modal-button confirm">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="aiAnalysisModal" class="modal">
        <div class="modal-content">
            <h3 id="aiModalTitle">An√°lise da Carteira com IA (Gemini)</h3>
            <div id="aiResult">Aguardando an√°lise...</div>
            <div class="modal-buttons">
                <button type="button" class="modal-button cancel" id="cancelAi">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        let assetsState = [
            { id: 'cacr11', name: 'CACR11', segment: 'Papel', type: 'fiis', targetPct: 0.10, myQty: 10, currentPrice: 0, dy: 0 },
            { id: 'mxrf11', name: 'MXRF11', segment: 'Papel', type: 'fiis', targetPct: 0.15, myQty: 22, currentPrice: 0, dy: 0 },
            { id: 'vgir11', name: 'VGIR11', segment: 'Papel', type: 'fiis', targetPct: 0.10, myQty: 17, currentPrice: 0, dy: 0 },
            { id: 'habt11', name: 'HABT11', segment: 'Papel', type: 'fiis', targetPct: 0.05, myQty: 1, currentPrice: 0, dy: 0 },
            { id: 'gare11', name: 'GARE11', segment: 'Tijolo', type: 'fiis', targetPct: 0.10, myQty: 23, currentPrice: 0, dy: 0 },
            { id: 'ggrc11', name: 'GGRC11', segment: 'Tijolo', type: 'fiis', targetPct: 0.15, myQty: 0, currentPrice: 0, dy: 0 },
            { id: 'xpml11', name: 'XPML11', segment: 'Tijolo', type: 'fiis', targetPct: 0.15, myQty: 0, currentPrice: 0, dy: 0 },
            { id: 'snag11', name: 'SNAG11', segment: 'Fiagro', type: 'fiagros', targetPct: 0.20, myQty: 0, currentPrice: 0, dy: 0 },
            { id: 'mana11', name: 'MANA11', segment: 'Outro', type: 'fiis', targetPct: 0.00, myQty: 1, currentPrice: 0, dy: 0 }
        ];

        let targetChart, currentChart;
        let currentChartType = 'doughnut';
        Chart.register(ChartDataLabels);

        function renderTable() {
            const tbody = document.getElementById('portfolio-body');
            tbody.innerHTML = ''; 
            
            assetsState.forEach(asset => {
                const row = document.createElement('tr');
                row.id = `row_${asset.id}`;
                const priceValue = asset.currentPrice > 0 ? asset.currentPrice.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
                const dyValue = asset.dy > 0 ? asset.dy.toFixed(2) : '';
                
                const assetTypePath = asset.type || 'fiis';
                const investidor10Url = `https://investidor10.com.br/${assetTypePath}/${asset.name.toLowerCase()}/`;
                
                row.innerHTML = `
                    <td><b>${asset.name}</b></td>
                    <td>${asset.segment}</td>
                    <td><input type="number" id="target_pct_${asset.id}" value="${(asset.targetPct * 100).toFixed(2)}" step="0.1" oninput="calculatePortfolio()"></td>
                    <td><input type="number" id="qty_${asset.id}" value="${asset.myQty}" step="1" oninput="calculatePortfolio()"></td>
                    <td><input type="text" class="price-input" id="price_${asset.id}" value="${priceValue}" placeholder="0,00" onblur="formatAndRecalculate(this)" onfocus="this.select()"></td>
                    <td><input type="number" id="dy_${asset.id}" value="${dyValue}" step="0.1" placeholder="0.00" oninput="calculatePortfolio()"></td>
                    <td><a href="${investidor10Url}" target="_blank" class="action-btn search-btn" title="Ver no Investidor10">üîç</a></td>
                    <td class="output" id="value_${asset.id}">-</td>
                    <td class="output" id="monthly_dividend_${asset.id}">-</td>
                    <td class="output" id="pct_${asset.id}">-</td>
                    <td class="output" id="gap_${asset.id}">-</td>
                    <td class="output" id="status_${asset.id}">-</td>
                    <td class="output" id="priority_${asset.id}">-</td>
                    <td class="output" id="shares_to_buy_${asset.id}">-</td>
                    <td class="output" id="value_to_buy_${asset.id}">-</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        function formatAndRecalculate(element) {
            let value = element.value;
            if (!value) {
                calculatePortfolio();
                return;
            };
            let numericValue = parseFloat(value.replace(/[^\d]/g, ''));
            if (isNaN(numericValue)) {
                element.value = '';
            } else {
                numericValue /= 100;
                element.value = numericValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            calculatePortfolio();
        }
        
        function syncStateWithDOM() {
            assetsState.forEach(asset => {
                const targetPctInput = document.getElementById(`target_pct_${asset.id}`);
                const qtyInput = document.getElementById(`qty_${asset.id}`);
                const priceInput = document.getElementById(`price_${asset.id}`);
                const dyInput = document.getElementById(`dy_${asset.id}`);

                if (targetPctInput) asset.targetPct = parseFloat(targetPctInput.value) / 100 || 0;
                if (qtyInput) asset.myQty = parseInt(qtyInput.value) || 0;
                if (priceInput) {
                    const priceStr = priceInput.value || '0';
                    asset.currentPrice = parseFloat(priceStr.replace(/\./g, '').replace(',', '.')) || 0;
                }
                if (dyInput) asset.dy = parseFloat(dyInput.value) || 0;
            });
        }

        function calculatePortfolio() {
            syncStateWithDOM();
            saveStateToLocalStorage();
            const aporteMensal = parseFloat(document.getElementById('aporteMensal').value) || 0;
            let totalPatrimonio = 0;
            let totalTargetPct = 0;
            let totalAnnualDividends = 0;
            
            let currentAssets = assetsState.map(asset => {
                const myValue = asset.myQty * asset.currentPrice;
                totalPatrimonio += myValue;
                totalTargetPct += asset.targetPct;
                if (asset.dy > 0) {
                    totalAnnualDividends += myValue * (asset.dy / 100);
                }
                return { ...asset, myValue };
            });

            currentAssets = currentAssets.map(asset => {
                const currentPct = totalPatrimonio > 0 ? asset.myValue / totalPatrimonio : 0;
                const targetValue = (totalPatrimonio + aporteMensal) * asset.targetPct;
                const gap = targetValue - asset.myValue;
                const status = gap > 0 && asset.currentPrice > 0 ? "Aportar" : "Aguardar";
                const monthlyDividend = (asset.myValue * (asset.dy / 100)) / 12;
                return { ...asset, currentPct, gap, status, monthlyDividend };
            });

            const assetsToRank = currentAssets.filter(a => a.status === 'Aportar').sort((a, b) => b.gap - a.gap);
            currentAssets = currentAssets.map(asset => {
                const rank = assetsToRank.findIndex(a => a.id === asset.id);
                let priority = "Nenhuma";
                let priorityClass = "priority-nenhuma";
                if (rank !== -1) {
                    if (rank <= 1) { priority = "ALTA"; priorityClass = "priority-alta"; } 
                    else if (rank <= 3) { priority = "M√âDIA"; priorityClass = "priority-media"; } 
                    else { priority = "BAIXA"; priorityClass = "priority-baixa"; }
                }
                return { ...asset, rank, priority, priorityClass };
            });

            let aporteRestante = aporteMensal;
            let totalCotasComprar = 0;
            let totalAporteReal = 0;
            currentAssets.sort((a, b) => (a.rank === -1 ? 99 : a.rank) - (b.rank === -1 ? 99 : b.rank));
            currentAssets.forEach(asset => {
                let aporteReal = 0;
                if (asset.status === 'Aportar' && aporteRestante > 0) {
                    aporteReal = Math.min(asset.gap, aporteRestante);
                }
                const cotasComprar = asset.currentPrice > 0 ? Math.floor(aporteReal / asset.currentPrice) : 0;
                const valorFinalCotas = cotasComprar * asset.currentPrice;
                asset.cotasComprar = cotasComprar;
                asset.valorFinalCotas = valorFinalCotas;
                aporteRestante -= valorFinalCotas;
                totalCotasComprar += cotasComprar;
                totalAporteReal += valorFinalCotas;
            });

            currentAssets.sort((a,b) => assetsState.findIndex(p => p.id === a.id) - assetsState.findIndex(p => p.id === b.id));
            currentAssets.forEach(asset => {
                document.getElementById(`value_${asset.id}`).textContent = formatCurrency(asset.myValue);
                document.getElementById(`monthly_dividend_${asset.id}`).textContent = formatCurrency(asset.monthlyDividend);
                document.getElementById(`pct_${asset.id}`).textContent = `${(asset.currentPct * 100).toFixed(2)}%`;
                document.getElementById(`gap_${asset.id}`).textContent = formatCurrency(asset.gap);
                document.getElementById(`status_${asset.id}`).className = `output ${asset.status === 'Aportar' ? 'status-aportar' : 'status-aguardar'}`;
                document.getElementById(`status_${asset.id}`).textContent = asset.status;
                document.getElementById(`priority_${asset.id}`).className = `output ${asset.priorityClass}`;
                document.getElementById(`priority_${asset.id}`).textContent = asset.priority;
                document.getElementById(`shares_to_buy_${asset.id}`).textContent = asset.cotasComprar > 0 ? asset.cotasComprar : '-';
                document.getElementById(`value_to_buy_${asset.id}`).textContent = asset.valorFinalCotas > 0 ? formatCurrency(asset.valorFinalCotas) : '-';
            });

            document.getElementById('totalPatrimonioTop').textContent = formatCurrency(totalPatrimonio);
            const targetPctTotalEl = document.getElementById('targetPctTotal');
            targetPctTotalEl.textContent = `${(totalTargetPct * 100).toFixed(2)}%`;
            targetPctTotalEl.classList.toggle('invalid', Math.abs(totalTargetPct - 1.0) > 0.001);
            document.getElementById('totalAporteReal').textContent = formatCurrency(totalAporteReal);
            document.getElementById('totalCotasComprar').textContent = totalCotasComprar;
            document.getElementById('monthlyDividends').textContent = formatCurrency(totalAnnualDividends / 12);

            updateCharts(currentAssets, totalPatrimonio);
        }

        const addModal = document.getElementById('addAssetModal');
        const removeModal = document.getElementById('removeAssetModal');
        const aiModal = document.getElementById('aiAnalysisModal');
        
        document.getElementById('addAssetBtn').onclick = () => { addModal.style.display = 'block'; };
        document.getElementById('removeAssetBtn').onclick = () => { removeModal.style.display = 'block'; };
        document.getElementById('aiAnalysisBtn').onclick = () => { analyzeWithAI(); };
        document.getElementById('aiSuggestBtn').onclick = () => { suggestAssetWithAI(); };

        document.getElementById('cancelAdd').onclick = () => { addModal.style.display = 'none'; };
        document.getElementById('cancelRemove').onclick = () => { removeModal.style.display = 'none'; };
        document.getElementById('cancelAi').onclick = () => { aiModal.style.display = 'none'; };
        
        window.onclick = (event) => {
            if (event.target == addModal || event.target == removeModal || event.target == aiModal) {
                addModal.style.display = "none";
                removeModal.style.display = "none";
                aiModal.style.display = "none";
            }
        };

        document.getElementById('addAssetForm').addEventListener('submit', (e) => {
            e.preventDefault();
            syncStateWithDOM();
            const name = document.getElementById('newAssetName').value;
            const segment = document.getElementById('newAssetSegment').value;
            const targetPct = parseFloat(document.getElementById('newAssetTargetPct').value) / 100;

            if (!name || !segment || isNaN(targetPct) || targetPct <= 0 || targetPct >= 1) {
                alert("Dados inv√°lidos. Verifique os campos e tente novamente.");
                return;
            }
            
            let type = 'fiis';
            if (segment.toLowerCase().includes('fiagro')) {
                type = 'fiagros';
            } else if (segment.toLowerCase().includes('a√ß') || segment.toLowerCase().includes('a√ßao') || segment.toLowerCase().includes('acoes')) {
                 type = 'acoes';
            }

            const scaleFactor = 1 - targetPct;
            assetsState.forEach(asset => { asset.targetPct *= scaleFactor; });

            const newAsset = {
                id: name.toLowerCase().replace(/[^a-z0-9]/g, '') + Date.now(),
                name: name.toUpperCase(),
                segment: segment,
                type: type,
                targetPct: targetPct,
                myQty: 0,
                currentPrice: 0,
                dy: 0
            };
            assetsState.push(newAsset);
            
            const totalPctSum = assetsState.reduce((sum, asset) => sum + asset.targetPct, 0);
            assetsState.forEach(asset => asset.targetPct /= totalPctSum);

            renderTable();
            calculatePortfolio();
            addModal.style.display = 'none';
            e.target.reset();
        });

        document.getElementById('removeAssetForm').addEventListener('submit', (e) => {
            e.preventDefault();
            syncStateWithDOM();
            const nameToRemove = document.getElementById('removeAssetName').value.toUpperCase();
            const assetIndex = assetsState.findIndex(asset => asset.name === nameToRemove);

            if (assetIndex === -1) {
                alert(`Ativo "${nameToRemove}" n√£o encontrado na carteira.`);
                return;
            }
            if (assetsState.length <= 1) {
                alert("N√£o √© poss√≠vel remover o √∫ltimo ativo.");
                return;
            }

            assetsState.splice(assetIndex, 1);
            
            const remainingSum = assetsState.reduce((sum, asset) => sum + asset.targetPct, 0);
            if (remainingSum > 0) {
                 assetsState.forEach(asset => { asset.targetPct /= remainingSum; });
            }

            renderTable();
            calculatePortfolio();
            removeModal.style.display = 'none';
            e.target.reset();
        });
        
        function changeChartType() {
            currentChartType = document.getElementById('chartTypeSelector').value;
            calculatePortfolio(); // For√ßa o redesenho dos gr√°ficos
        }

        function updateCharts(data, totalPatrimonio) {
            const labels = data.map(a => a.name);
            const targetData = data.map(a => a.targetPct * 100);
            const currentData = data.map(a => a.currentPct * 100);

            const targetDividends = data.map(a => (totalPatrimonio * a.targetPct * (a.dy / 100)) / 12);
            const currentDividends = data.map(a => a.monthlyDividend);
            
            const chartTypeForJs = currentChartType === 'barVertical' ? 'bar' : currentChartType;
            const indexAxis = currentChartType === 'bar' ? 'y' : 'x';

            const chartConfig = (title, chartData, dividendData) => ({
                type: chartTypeForJs,
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% da Carteira',
                        data: chartData,
                        dividends: dividendData,
                        backgroundColor: [
                            '#2c3e50', '#e74c3c', '#3498db', '#f1c40f',
                            '#1abc9c', '#9b59b6', '#34495e', '#e67e22', '#95a5a6'
                        ],
                        borderColor: '#fff',
                        borderWidth: (currentChartType === 'bar' || currentChartType === 'barVertical') ? 0 : 2
                    }]
                },
                options: {
                    indexAxis: indexAxis,
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: title, font: { size: 16 } },
                        datalabels: {
                            color: (currentChartType === 'bar' || currentChartType === 'barVertical') ? '#333' : '#fff',
                            anchor: (currentChartType === 'bar' || currentChartType === 'barVertical') ? 'end' : 'center',
                            align: (currentChartType === 'bar' || currentChartType === 'barVertical') ? 'start' : 'center',
                            textAlign: 'center',
                            font: { weight: 'bold', size: 11 },
                            formatter: (value, context) => {
                                if (value < 4 && (currentChartType !== 'bar' && currentChartType !== 'barVertical')) return '';
                                const label = context.chart.data.labels[context.dataIndex];
                                const dividend = context.chart.data.datasets[0].dividends[context.dataIndex];
                                const dividendString = dividend > 0 ? `\n${formatCurrency(dividend)}` : '';
                                return `${label}\n${value.toFixed(1)}%${dividendString}`;
                            }
                        }
                    }
                }
            });

            if (targetChart) targetChart.destroy();
            targetChart = new Chart(document.getElementById('targetAllocationChart'), chartConfig('Aloca√ß√£o Ideal (% Alvo)', targetData, targetDividends));

            if (currentChart) currentChart.destroy();
            currentChart = new Chart(document.getElementById('currentAllocationChart'), chartConfig('Aloca√ß√£o Atual (%)', currentData, currentDividends));
        }

        function saveStateToLocalStorage() {
            localStorage.setItem('portfolioManagerData', JSON.stringify(assetsState));
        }

        function loadStateFromLocalStorage() {
            const savedData = localStorage.getItem('portfolioManagerData');
            if (savedData) {
                assetsState = JSON.parse(savedData);
            }
        }
        
        async function analyzeWithAI() {
            syncStateWithDOM();
            const aiModalTitle = document.getElementById('aiModalTitle');
            const aiResultDiv = document.getElementById('aiResult');
            aiModalTitle.textContent = 'An√°lise da Carteira com IA (Gemini)';
            aiModal.style.display = 'block';
            aiResultDiv.textContent = 'O prompt para a an√°lise foi copiado para a sua √°rea de transfer√™ncia. Cole-o (Ctrl+V) na conversa com a IA que abriu na nova aba para obter a sua an√°lise.';

            const portfolioData = assetsState.map(asset => {
                const totalPatrimonio = assetsState.reduce((sum, a) => sum + (a.myQty * a.currentPrice), 0) || 1;
                return {
                    ativo: asset.name,
                    segmento: asset.segment,
                    percentual_atual: ((asset.myQty * asset.currentPrice) / totalPatrimonio * 100).toFixed(2) + '%',
                    percentual_alvo: (asset.targetPct * 100).toFixed(2) + '%'
                }
            });

            const prompt = `
                Por favor, atue como um analista de investimentos. Analise a seguinte carteira de investimentos de um investidor brasileiro cujo objetivo principal √© receber altos dividendos mensais.

                Dados da Carteira:
                ${JSON.stringify(portfolioData, null, 2)}

                Com base nestes dados, forne√ßa uma an√°lise concisa e objetiva em portugu√™s do Brasil, seguindo os seguintes pontos:
                1.  **Ponto Forte Principal:** Identifique o principal ponto positivo da carteira.
                2.  **Ponto de Aten√ß√£o Principal:** Aponte o principal risco ou ponto a ser melhorado (ex: concentra√ß√£o em um ativo ou setor).
                3.  **Sugest√£o de Melhoria:** D√™ uma sugest√£o clara e pr√°tica de como o investidor pode melhorar a carteira, considerando o objetivo de dividendos. Pode sugerir rebalanceamento ou a inclus√£o de um tipo de ativo que est√° em falta.
                4.  **Conclus√£o:** Uma frase final de encorajamento.

                Seja direto e use uma linguagem f√°cil de entender.
            `;
            
            try {
                await navigator.clipboard.writeText(prompt);
                window.open('https://gemini.google.com/', '_blank');
            } catch (err) {
                console.error('Falha ao copiar o prompt: ', err);
                aiResultDiv.textContent = 'N√£o foi poss√≠vel copiar o prompt. Por favor, tente novamente.';
            }
        }

        async function suggestAssetWithAI() {
            syncStateWithDOM();
            const aiModalTitle = document.getElementById('aiModalTitle');
            const aiResultDiv = document.getElementById('aiResult');
            aiModalTitle.textContent = 'Sugest√£o de Novo Ativo com IA (Gemini)';
            aiModal.style.display = 'block';
            aiResultDiv.textContent = 'O prompt para a sugest√£o foi copiado para a sua √°rea de transfer√™ncia. Cole-o (Ctrl+V) na conversa com a IA que abriu na nova aba para obter a sua sugest√£o.';

            const existingAssets = assetsState.map(a => a.name).join(', ');
            const portfolioData = assetsState.map(asset => ({
                ativo: asset.name,
                segmento: asset.segment,
                percentual_alvo: (asset.targetPct * 100).toFixed(2) + '%'
            }));

            const prompt = `
                Atue como um analista de investimentos focado no mercado brasileiro. A carteira de um investidor, que busca altos dividendos mensais, √© a seguinte:
                ${JSON.stringify(portfolioData, null, 2)}

                Sugira UM √öNICO novo ativo (FII ou Fiagro) que complementaria bem esta carteira, focando em diversifica√ß√£o e potencial de dividendos. N√£o sugira nenhum dos seguintes ativos que j√° est√£o na carteira: ${existingAssets}.

                Forne√ßa sua resposta em formato de texto simples, com a seguinte estrutura:
                Ativo: [TICKER DO ATIVO]
                Segmento: [SEGMENTO DO ATIVO]
                Justificativa: [Uma breve justificativa (2-3 frases) explicando por que este ativo √© uma boa adi√ß√£o para esta carteira espec√≠fica.]
            `;

            try {
                await navigator.clipboard.writeText(prompt);
                window.open('https://gemini.google.com/', '_blank');
            } catch (err) {
                console.error('Falha ao copiar o prompt para sugest√£o:', err);
                aiResultDiv.textContent = 'N√£o foi poss√≠vel copiar o prompt. Por favor, tente novamente.';
            }
        }

        window.onload = () => {
            loadStateFromLocalStorage();
            renderTable();
            calculatePortfolio();
        };
    </script>
</body>
</html>
