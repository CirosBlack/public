<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Balanceamento de Carteira (com IA)</title>
    <!-- Chart.js e plugin de datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        /* Estilos Gerais */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            justify-content: center;
            padding: 10px;
            margin: 0;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 1500px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            text-align: center;
            color: #2c3e50;
        }
        /* Tabela Responsiva e Orden√°vel */
        .table-container {
            width: 100%;
            overflow-x: auto; 
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #dfe6e9;
            padding: 12px 8px;
            text-align: center;
            font-size: 14px;
        }
        th {
            background-color: #34495e;
            color: #fff;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th.sortable {
            cursor: pointer;
            position: relative;
        }
        th.sortable:hover {
            background-color: #4a627a;
        }
        .sort-arrow {
            margin-left: 5px;
            opacity: 0.5;
        }
        th.sorted .sort-arrow {
            opacity: 1;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        input[type="number"], input[type="text"], select {
            width: 90%;
            padding: 8px;
            border: 1px solid #b2bec3;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            min-width: 70px;
            box-sizing: border-box;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #c0392b;
        }
        /* PAINEL DE CONTROLO (DASHBOARD) */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        .dashboard-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .dashboard-card label {
            font-size: 14px;
            color: #7f8c8d;
            display: block;
            margin-bottom: 8px;
        }
        .dashboard-card .value, .dashboard-card input {
            font-size: 22px;
            font-weight: bold;
            color: #2c3e50;
        }
        .dashboard-card input {
            width: 100%;
            box-sizing: border-box;
            border: none;
            background: transparent;
            padding: 0;
        }
        #targetPctTotal.invalid {
            color: #c0392b;
        }

        .output { font-weight: bold; }
        .status-aportar { color: #27ae60; }
        .status-aguardar { color: #7f8c8d; }
        .priority-alta { background-color: #f8d7da; color: #721c24; font-weight: bold; }
        .priority-media { background-color: #fff3cd; color: #856404; font-weight: bold; }
        .priority-baixa { background-color: #d4edda; color: #155724; font-weight: bold; }
        .priority-nenhuma { background-color: #e9ecef; color: #495057; }
        
        /* Gerenciamento de Ativos (Bot√µes) */
        .asset-management {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .asset-management button, .modal-button, .action-btn {
            background-color: #34495e;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
            text-decoration: none;
        }
        .asset-management button:hover { background-color: #4a627a; }
        .action-btn {
             padding: 5px 12px;
        }
        .search-btn {
            background-color: #2980b9;
        }
        .search-btn:hover {
            background-color: #3498db;
        }
        #aiAnalysisBtn, #aiSuggestBtn, #aiSuggestFixedIncomeBtn, #aiSuggestOthersBtn, #aiOptimizeBtn {
            background-color: #8e44ad;
        }
        #aiAnalysisBtn:hover, #aiSuggestBtn:hover, #aiSuggestFixedIncomeBtn:hover, #aiSuggestOthersBtn:hover, #aiOptimizeBtn:hover {
            background-color: #9b59b6;
        }
        
        /* NOVO PAINEL DE COMPRA R√ÅPIDA */
        .quick-add-panel {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-top: 25px;
            border-left: 5px solid #2980b9;
        }
        .quick-add-panel h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        .quick-add-form {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .quick-add-form .form-group {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        .quick-add-form label {
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        .quick-add-form input {
            min-width: 150px;
        }
        .quick-add-form button {
            background-color: #2980b9;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .quick-add-form button:hover {
            background-color: #3498db;
        }


        /* Gr√°ficos */
        .charts-header {
            text-align: center;
            margin-top: 30px;
        }
        .charts-header select {
            padding: 8px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #dfe6e9;
        }
        .charts-container {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .chart-wrapper {
            width: 100%;
            max-width: 450px; /* Tamanho m√°ximo dos gr√°ficos */
            margin: 0 auto;
        }

        /* Estilos do Modal (Pop-up) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #aiResult {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            text-align: left;
            border: 1px solid #dfe6e9;
        }
        .modal-form-group {
            display: flex;
            flex-direction: column;
        }
        .modal-form-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .modal-form-group input {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }
        .modal-button.confirm { background-color: #27ae60; }
        .modal-button.confirm:hover { background-color: #2ecc71; }
        .modal-button.cancel { background-color: #7f8c8d; }
        .modal-button.cancel:hover { background-color: #95a5a6; }

        /* Media Queries para Responsividade */
        @media (max-width: 992px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 576px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .chart-wrapper {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Calculadora de Balanceamento de Carteira</h1>

        <!-- NOVO DASHBOARD -->
        <div class="dashboard">
            <div class="dashboard-card">
                <label>üí∞ Patrim√¥nio Total</label>
                <span id="totalPatrimonioTop" class="value">R$ 0,00</span>
            </div>
            <div class="dashboard-card">
                <label>üíµ Renda Mensal (Est.)</label>
                <span id="monthlyDividends" class="value">R$ 0,00</span>
            </div>
            <div class="dashboard-card">
                <label>üéØ Soma % Alvo</label>
                <span id="targetPctTotal" class="value">100.00%</span>
            </div>
            <div class="dashboard-card">
                <label>üí∏ Aporte Mensal (R$)</label>
                <input type="number" id="aporteMensal" value="500" step="50" oninput="calculatePortfolio()">
            </div>
            <div class="dashboard-card">
                <label>üìà Total a Investir</label>
                <span id="totalAporteReal" class="value">R$ 0,00</span>
            </div>
             <div class="dashboard-card">
                <label>üì¶ Total de Cotas</label>
                <span id="totalCotasComprar" class="value">0</span>
            </div>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="sortable" data-sort-key="name">Ativo <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort-key="segment">Segmento <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort-key="targetPct">% Alvo <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort-key="myQty">Minha Qtd. <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort-key="currentPrice">Pre√ßo Atual (R$) <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort-key="dy">DY (12M) % <span class="sort-arrow"></span></th>
                        <th>A√ß√µes</th>
                        <th class="sortable" data-sort-key="myValue">Meu Valor (R$) <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort-key="monthlyDividend">Dividendo Mensal (Est.) <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort-key="currentPct">% Atual <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort-key="gap">Dist√¢ncia (R$) <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort-key="status">Status <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort-key="priority">Prioridade <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort-key="cotasComprar">Cotas a Comprar <span class="sort-arrow"></span></th>
                        <th class="sortable" data-sort-key="valorFinalCotas">Valor das Cotas (R$) <span class="sort-arrow"></span></th>
                    </tr>
                </thead>
                <tbody id="portfolio-body"></tbody>
            </table>
        </div>
        
        <!-- NOVO PAINEL DE COMPRA R√ÅPIDA -->
        <div class="quick-add-panel">
            <h3>Registrar Compra R√°pida</h3>
            <form id="quickAddForm" class="quick-add-form">
                <div class="form-group">
                    <label for="quickAddAssetName">Ativo</label>
                    <input type="text" id="quickAddAssetName" list="asset-list" required>
                    <datalist id="asset-list"></datalist>
                </div>
                <div class="form-group">
                    <label for="quickAddAssetQty">Quantidade de Cotas</label>
                    <input type="number" id="quickAddAssetQty" min="1" required>
                </div>
                <button type="submit">Adicionar Cotas</button>
            </form>
        </div>

        <div class="asset-management">
            <button id="addAssetBtn">Adicionar Novo Ativo</button>
            <button id="removeAssetBtn">Remover Ativo</button>
            <button id="aiAnalysisBtn">‚ú® Analisar Carteira</button>
            <button id="aiSuggestBtn">‚ú® Sugerir FII/Fiagro</button>
            <button id="aiSuggestFixedIncomeBtn">‚ú® Sugerir Renda Fixa</button>
            <button id="aiSuggestOthersBtn">‚ú® Sugerir Outros Ativos</button>
            <button id="aiOptimizeBtn">‚ú® Otimizar % Alvo</button>
        </div>

        <div class="charts-header">
            <h3>Visualiza√ß√£o da Carteira</h3>
            <select id="chartTypeSelector" onchange="changeChartType()">
                <option value="doughnut">Rosca</option>
                <option value="pie">Pizza</option>
                <option value="barVertical" selected>Barras (Vertical)</option>
                <option value="bar">Barras (Horizontal)</option>
                <option value="polarArea">√Årea Polar</option>
            </select>
        </div>

        <div class="charts-container">
            <div class="chart-wrapper">
                <canvas id="targetAllocationChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <canvas id="currentAllocationChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <div id="addAssetModal" class="modal">
        <div class="modal-content">
            <h3>Adicionar Novo Ativo</h3>
            <form id="addAssetForm">
                <div class="modal-form-group">
                    <label for="newAssetName">Nome do Ativo (ex: ITSA4)</label>
                    <input type="text" id="newAssetName" required>
                </div>
                <div class="modal-form-group">
                    <label for="newAssetSegment">Segmento (ex: A√ß√µes, FII)</label>
                    <input type="text" id="newAssetSegment" required>
                </div>
                <div class="modal-form-group">
                    <label for="newAssetTargetPct">% Alvo (apenas o n√∫mero)</label>
                    <input type="number" id="newAssetTargetPct" step="0.1" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="modal-button cancel" id="cancelAdd">Cancelar</button>
                    <button type="submit" class="modal-button confirm">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="removeAssetModal" class="modal">
        <div class="modal-content">
            <h3>Remover Ativo</h3>
            <form id="removeAssetForm">
                <div class="modal-form-group">
                    <label for="removeAssetName">Digite o nome do ativo a ser removido</label>
                    <input type="text" id="removeAssetName" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="modal-button cancel" id="cancelRemove">Cancelar</button>
                    <button type="submit" class="modal-button confirm">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="aiAnalysisModal" class="modal">
        <div class="modal-content">
            <h3 id="aiModalTitle">An√°lise da Carteira com IA (Gemini)</h3>
            <div id="aiResult">Aguardando an√°lise...</div>
            <div class="modal-buttons">
                <button type="button" class="modal-button cancel" id="cancelAi">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        let assetsState = [
            { id: 'cacr11', name: 'CACR11', segment: 'Papel', type: 'fiis', targetPct: 0.10, myQty: 10, currentPrice: 0, dy: 0 },
            { id: 'mxrf11', name: 'MXRF11', segment: 'Papel', type: 'fiis', targetPct: 0.15, myQty: 22, currentPrice: 0, dy: 0 },
            { id: 'vgir11', name: 'VGIR11', segment: 'Papel', type: 'fiis', targetPct: 0.10, myQty: 17, currentPrice: 0, dy: 0 },
            { id: 'habt11', name: 'HABT11', segment: 'Papel', type: 'fiis', targetPct: 0.05, myQty: 1, currentPrice: 0, dy: 0 },
            { id: 'gare11', name: 'GARE11', segment: 'Tijolo', type: 'fiis', targetPct: 0.10, myQty: 23, currentPrice: 0, dy: 0 },
            { id: 'ggrc11', name: 'GGRC11', segment: 'Tijolo', type: 'fiis', targetPct: 0.15, myQty: 0, currentPrice: 0, dy: 0 },
            { id: 'xpml11', name: 'XPML11', segment: 'Tijolo', type: 'fiis', targetPct: 0.15, myQty: 0, currentPrice: 0, dy: 0 },
            { id: 'snag11', name: 'SNAG11', segment: 'Fiagro', type: 'fiagros', targetPct: 0.20, myQty: 0, currentPrice: 0, dy: 0 },
            { id: 'mana11', name: 'MANA11', segment: 'Outro', type: 'fiis', targetPct: 0.00, myQty: 1, currentPrice: 0, dy: 0 }
        ];

        let targetChart, currentChart;
        let currentChartType = 'barVertical'; // Gr√°fico padr√£o
        let sortConfig = { key: 'name', direction: 'asc' }; // Configura√ß√£o de ordena√ß√£o padr√£o

        Chart.register(ChartDataLabels);

        function renderTable() {
            const tbody = document.getElementById('portfolio-body');
            tbody.innerHTML = ''; 
            
            assetsState.forEach(asset => {
                const row = document.createElement('tr');
                row.id = `row_${asset.id}`;
                const priceValue = asset.currentPrice > 0 ? asset.currentPrice.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '';
                const dyValue = asset.dy > 0 ? asset.dy.toFixed(2) : '';
                
                const assetTypePath = asset.type || 'fiis';
                const investidor10Url = `https://investidor10.com.br/${assetTypePath}/${asset.name.toLowerCase()}/`;
                
                row.innerHTML = `
                    <td><b>${asset.name}</b></td>
                    <td>${asset.segment}</td>
                    <td><input type="number" id="target_pct_${asset.id}" value="${(asset.targetPct * 100).toFixed(2)}" step="0.1" oninput="calculatePortfolio()"></td>
                    <td><input type="number" id="qty_${asset.id}" value="${asset.myQty}" step="1" oninput="calculatePortfolio()"></td>
                    <td><input type="text" class="price-input" id="price_${asset.id}" value="${priceValue}" placeholder="0,00" onblur="formatAndRecalculate(this)" onfocus="this.select()"></td>
                    <td><input type="number" id="dy_${asset.id}" value="${dyValue}" step="0.1" placeholder="0.00" oninput="calculatePortfolio()"></td>
                    <td><a href="${investidor10Url}" target="_blank" class="action-btn search-btn" title="Ver no Investidor10">üîç</a></td>
                    <td class="output" id="value_${asset.id}">-</td>
                    <td class="output" id="monthly_dividend_${asset.id}">-</td>
                    <td class="output" id="pct_${asset.id}">-</td>
                    <td class="output" id="gap_${asset.id}">-</td>
                    <td class="output" id="status_${asset.id}">-</td>
                    <td class="output" id="priority_${asset.id}">-</td>
                    <td class="output" id="shares_to_buy_${asset.id}">-</td>
                    <td class="output" id="value_to_buy_${asset.id}">-</td>
                `;
                tbody.appendChild(row);
            });
            updateAssetDatalist();
        }
        
        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        
        function formatAndRecalculate(element) {
            let value = element.value;
            if (!value) {
                calculatePortfolio();
                return;
            };
            let numericValue = parseFloat(value.replace(/[^\d]/g, ''));
            if (isNaN(numericValue)) {
                element.value = '';
            } else {
                numericValue /= 100;
                element.value = numericValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            calculatePortfolio();
        }
        
        function syncStateWithDOM() {
            assetsState.forEach(asset => {
                const targetPctInput = document.getElementById(`target_pct_${asset.id}`);
                const qtyInput = document.getElementById(`qty_${asset.id}`);
                const priceInput = document.getElementById(`price_${asset.id}`);
                const dyInput = document.getElementById(`dy_${asset.id}`);

                if (targetPctInput) asset.targetPct = parseFloat(targetPctInput.value) / 100 || 0;
                if (qtyInput) asset.myQty = parseInt(qtyInput.value) || 0;
                if (priceInput) {
                    const priceStr = priceInput.value || '0';
                    asset.currentPrice = parseFloat(priceStr.replace(/\./g, '').replace(',', '.')) || 0;
                }
                if (dyInput) asset.dy = parseFloat(dyInput.value) || 0;
            });
        }

        function calculatePortfolio() {
            syncStateWithDOM();
            saveStateToLocalStorage();
            const aporteMensal = parseFloat(document.getElementById('aporteMensal').value) || 0;
            let totalPatrimonio = 0;
            let totalTargetPct = 0;
            let totalAnnualDividends = 0;
            
            let currentAssets = assetsState.map(asset => {
                const myValue = asset.myQty * asset.currentPrice;
                totalPatrimonio += myValue;
                totalTargetPct += asset.targetPct;
                if (asset.dy > 0) {
                    totalAnnualDividends += myValue * (asset.dy / 100);
                }
                return { ...asset, myValue };
            });

            currentAssets = currentAssets.map(asset => {
                const currentPct = totalPatrimonio > 0 ? asset.myValue / totalPatrimonio : 0;
                const targetValue = (totalPatrimonio + aporteMensal) * asset.targetPct;
                const gap = targetValue - asset.myValue;
                const status = gap > 0 && asset.currentPrice > 0 ? "Aportar" : "Aguardar";
                const monthlyDividend = (asset.myValue * (asset.dy / 100)) / 12;
                return { ...asset, currentPct, gap, status, monthlyDividend };
            });

            const assetsToRank = currentAssets.filter(a => a.status === 'Aportar').sort((a, b) => b.gap - a.gap);
            currentAssets = currentAssets.map(asset => {
                const rank = assetsToRank.findIndex(a => a.id === asset.id);
                let priority = "Nenhuma";
                let priorityClass = "priority-nenhuma";
                if (rank !== -1) {
                    if (rank <= 1) { priority = "ALTA"; priorityClass = "priority-alta"; } 
                    else if (rank <= 3) { priority = "M√âDIA"; priorityClass = "priority-media"; } 
                    else { priority = "BAIXA"; priorityClass = "priority-baixa"; }
                }
                return { ...asset, rank, priority, priorityClass };
            });

            let aporteRestante = aporteMensal;
            let totalCotasComprar = 0;
            let totalAporteReal = 0;
            currentAssets.sort((a, b) => (a.rank === -1 ? 99 : a.rank) - (b.rank === -1 ? 99 : b.rank));
            currentAssets.forEach(asset => {
                let aporteReal = 0;
                if (asset.status === 'Aportar' && aporteRestante > 0) {
                    aporteReal = Math.min(asset.gap, aporteRestante);
                }
                const cotasComprar = asset.currentPrice > 0 ? Math.floor(aporteReal / asset.currentPrice) : 0;
                const valorFinalCotas = cotasComprar * asset.currentPrice;
                asset.cotasComprar = cotasComprar;
                asset.valorFinalCotas = valorFinalCotas;
                aporteRestante -= valorFinalCotas;
                totalCotasComprar += cotasComprar;
                totalAporteReal += valorFinalCotas;
            });

            currentAssets.sort((a,b) => assetsState.findIndex(p => p.id === a.id) - assetsState.findIndex(p => p.id === b.id));
            currentAssets.forEach(asset => {
                document.getElementById(`value_${asset.id}`).textContent = formatCurrency(asset.myValue);
                document.getElementById(`monthly_dividend_${asset.id}`).textContent = formatCurrency(asset.monthlyDividend);
                document.getElementById(`pct_${asset.id}`).textContent = `${(asset.currentPct * 100).toFixed(2)}%`;
                document.getElementById(`gap_${asset.id}`).textContent = formatCurrency(asset.gap);
                document.getElementById(`status_${asset.id}`).className = `output ${asset.status === 'Aportar' ? 'status-aportar' : 'status-aguardar'}`;
                document.getElementById(`status_${asset.id}`).textContent = asset.status;
                document.getElementById(`priority_${asset.id}`).className = `output ${asset.priorityClass}`;
                document.getElementById(`priority_${asset.id}`).textContent = asset.priority;
                document.getElementById(`shares_to_buy_${asset.id}`).textContent = asset.cotasComprar > 0 ? asset.cotasComprar : '-';
                document.getElementById(`value_to_buy_${asset.id}`).textContent = asset.valorFinalCotas > 0 ? formatCurrency(asset.valorFinalCotas) : '-';
            });

            document.getElementById('totalPatrimonioTop').textContent = formatCurrency(totalPatrimonio);
            const targetPctTotalEl = document.getElementById('targetPctTotal');
            targetPctTotalEl.textContent = `${(totalTargetPct * 100).toFixed(2)}%`;
            targetPctTotalEl.classList.toggle('invalid', Math.abs(totalTargetPct - 1.0) > 0.001);
            document.getElementById('totalAporteReal').textContent = formatCurrency(totalAporteReal);
            document.getElementById('totalCotasComprar').textContent = totalCotasComprar;
            document.getElementById('monthlyDividends').textContent = formatCurrency(totalAnnualDividends / 12);

            updateCharts(currentAssets, totalPatrimonio);
        }

        const addModal = document.getElementById('addAssetModal');
        const removeModal = document.getElementById('removeAssetModal');
        const aiModal = document.getElementById('aiAnalysisModal');
        
        document.getElementById('addAssetBtn').onclick = () => { addModal.style.display = 'block'; };
        document.getElementById('removeAssetBtn').onclick = () => { removeModal.style.display = 'block'; };
        document.getElementById('aiAnalysisBtn').onclick = () => { analyzeWithAI(); };
        document.getElementById('aiSuggestBtn').onclick = () => { suggestAssetWithAI(); };
        document.getElementById('aiSuggestFixedIncomeBtn').onclick = () => { suggestFixedIncomeWithAI(); };
        document.getElementById('aiSuggestOthersBtn').onclick = () => { suggestOtherAssetsWithAI(); };
        document.getElementById('aiOptimizeBtn').onclick = () => { optimizeTargetWithAI(); };

        document.getElementById('cancelAdd').onclick = () => { addModal.style.display = 'none'; };
        document.getElementById('cancelRemove').onclick = () => { removeModal.style.display = 'none'; };
        document.getElementById('cancelAi').onclick = () => { aiModal.style.display = 'none'; };
        
        window.onclick = (event) => {
            if (event.target == addModal || event.target == removeModal || event.target == aiModal) {
                addModal.style.display = "none";
                removeModal.style.display = "none";
                aiModal.style.display = "none";
            }
        };

        document.getElementById('addAssetForm').addEventListener('submit', (e) => {
            e.preventDefault();
            syncStateWithDOM();
            const name = document.getElementById('newAssetName').value;
            const segment = document.getElementById('newAssetSegment').value;
            const targetPct = parseFloat(document.getElementById('newAssetTargetPct').value) / 100;

            if (!name || !segment || isNaN(targetPct) || targetPct <= 0 || targetPct >= 1) {
                alert("Dados inv√°lidos. Verifique os campos e tente novamente.");
                return;
            }
            
            let type = 'fiis';
            if (segment.toLowerCase().includes('fiagro')) {
                type = 'fiagros';
            } else if (segment.toLowerCase().includes('a√ß') || segment.toLowerCase().includes('a√ßao') || segment.toLowerCase().includes('acoes')) {
                 type = 'acoes';
            }

            const scaleFactor = 1 - targetPct;
            assetsState.forEach(asset => { asset.targetPct *= scaleFactor; });

            const newAsset = {
                id: name.toLowerCase().replace(/[^a-z0-9]/g, '') + Date.now(),
                name: name.toUpperCase(),
                segment: segment,
                type: type,
                targetPct: targetPct,
                myQty: 0,
                currentPrice: 0,
                dy: 0
            };
            assetsState.push(newAsset);
            
            const totalPctSum = assetsState.reduce((sum, asset) => sum + asset.targetPct, 0);
            assetsState.forEach(asset => asset.targetPct /= totalPctSum);

            renderTable();
            calculatePortfolio();
            addModal.style.display = 'none';
            e.target.reset();
        });

        document.getElementById('removeAssetForm').addEventListener('submit', (e) => {
            e.preventDefault();
            syncStateWithDOM();
            const nameToRemove = document.getElementById('removeAssetName').value.toUpperCase();
            const assetIndex = assetsState.findIndex(asset => asset.name === nameToRemove);

            if (assetIndex === -1) {
                alert(`Ativo "${nameToRemove}" n√£o encontrado na carteira.`);
                return;
            }
            if (assetsState.length <= 1) {
                alert("N√£o √© poss√≠vel remover o √∫ltimo ativo.");
                return;
            }

            assetsState.splice(assetIndex, 1);
            
            const remainingSum = assetsState.reduce((sum, asset) => sum + asset.targetPct, 0);
            if (remainingSum > 0) {
                 assetsState.forEach(asset => { asset.targetPct /= remainingSum; });
            }

            renderTable();
            calculatePortfolio();
            removeModal.style.display = 'none';
            e.target.reset();
        });
        
        function changeChartType() {
            currentChartType = document.getElementById('chartTypeSelector').value;
            calculatePortfolio();
        }

        function updateCharts(data, totalPatrimonio) {
            const labels = data.map(a => a.name);
            const targetData = data.map(a => a.targetPct * 100);
            const currentData = data.map(a => a.currentPct * 100);

            const targetDividends = data.map(a => (totalPatrimonio * a.targetPct * (a.dy / 100)) / 12);
            const currentDividends = data.map(a => a.monthlyDividend);
            
            const chartTypeForJs = currentChartType === 'barVertical' ? 'bar' : currentChartType;
            const indexAxis = currentChartType === 'bar' ? 'y' : 'x';

            const chartConfig = (title, chartData, dividendData) => ({
                type: chartTypeForJs,
                data: {
                    labels: labels,
                    datasets: [{
                        label: '% da Carteira',
                        data: chartData,
                        dividends: dividendData,
                        backgroundColor: [
                            '#2c3e50', '#e74c3c', '#3498db', '#f1c40f',
                            '#1abc9c', '#9b59b6', '#34495e', '#e67e22', '#95a5a6'
                        ],
                        borderColor: '#fff',
                        borderWidth: (currentChartType === 'bar' || currentChartType === 'barVertical') ? 0 : 2
                    }]
                },
                options: {
                    indexAxis: indexAxis,
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: title, font: { size: 16 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.y !== undefined && indexAxis === 'x' ? context.parsed.y : context.parsed.x;
                                    label += `${value.toFixed(2)}%`;
                                    const dividend = context.dataset.dividends[context.dataIndex];
                                    if(dividend > 0) {
                                        label += ` (${formatCurrency(dividend)}/m√™s)`;
                                    }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            color: (currentChartType === 'bar' || currentChartType === 'barVertical') ? '#333' : '#fff',
                            anchor: (currentChartType === 'bar' || currentChartType === 'barVertical') ? 'end' : 'center',
                            align: (currentChartType === 'bar' || currentChartType === 'barVertical') ? 'end' : 'center',
                            offset: (currentChartType === 'bar' || currentChartType === 'barVertical') ? 8 : 0,
                            textAlign: 'center',
                            font: { weight: 'bold', size: 11 },
                            formatter: (value, context) => {
                                if (currentChartType === 'bar' || currentChartType === 'barVertical') {
                                    return `${value.toFixed(1)}%`;
                                }
                                if (value < 4) return '';
                                const label = context.chart.data.labels[context.dataIndex];
                                const dividend = context.chart.data.datasets[0].dividends[context.dataIndex];
                                const dividendString = dividend > 0 ? `\n${formatCurrency(dividend)}` : '';
                                return `${label}\n${value.toFixed(1)}%${dividendString}`;
                            }
                        }
                    }
                }
            });

            if (targetChart) targetChart.destroy();
            targetChart = new Chart(document.getElementById('targetAllocationChart'), chartConfig('Aloca√ß√£o Ideal (% Alvo)', targetData, targetDividends));

            if (currentChart) currentChart.destroy();
            currentChart = new Chart(document.getElementById('currentAllocationChart'), chartConfig('Aloca√ß√£o Atual (%)', currentData, currentDividends));
        }

        function saveStateToLocalStorage() {
            localStorage.setItem('portfolioManagerData', JSON.stringify(assetsState));
        }

        function loadStateFromLocalStorage() {
            const savedData = localStorage.getItem('portfolioManagerData');
            if (savedData) {
                assetsState = JSON.parse(savedData);
            }
        }
        
        async function copyPromptToClipboardAndOpenGemini(prompt, modalTitle, modalResultDiv) {
            modalTitle.textContent = modalTitle.textContent;
            modalResultDiv.textContent = 'O prompt para a an√°lise foi copiado para a sua √°rea de transfer√™ncia. Cole-o (Ctrl+V) na conversa com a IA que abriu na nova aba para obter a sua an√°lise.';
            aiModal.style.display = 'block';

            try {
                await navigator.clipboard.writeText(prompt);
                window.open('https://gemini.google.com/', '_blank');
            } catch (err) {
                console.error('Falha ao copiar o prompt: ', err);
                modalResultDiv.textContent = 'N√£o foi poss√≠vel copiar o prompt. Por favor, tente novamente.';
            }
        }

        async function analyzeWithAI() {
            syncStateWithDOM();
            const portfolioData = assetsState.map(asset => {
                const totalPatrimonio = assetsState.reduce((sum, a) => sum + (a.myQty * a.currentPrice), 0) || 1;
                return {
                    ativo: asset.name,
                    segmento: asset.segment,
                    percentual_atual: ((asset.myQty * asset.currentPrice) / totalPatrimonio * 100).toFixed(2) + '%',
                    percentual_alvo: (asset.targetPct * 100).toFixed(2) + '%'
                }
            });

            const prompt = `
                Por favor, atue como um analista de investimentos certificado (CFA) especializado em estrat√©gias de renda passiva para investidores brasileiros. Considere o cen√°rio macroecon√¥mico atual do Brasil (taxa Selic, infla√ß√£o, etc.) e que todos os investimentos s√£o feitos atrav√©s da plataforma do Nubank.

                Analise a seguinte carteira de investimentos do investidor Ciro, cujo objetivo principal √© maximizar a gera√ß√£o de dividendos mensais de forma sustent√°vel e segura.

                **Dados da Carteira:**
                ${JSON.stringify(portfolioData, null, 2)}

                **Sua an√°lise deve seguir estritamente a seguinte estrutura:**

                **1. Diagn√≥stico Geral:**
                   - **Pontua√ß√£o de Diversifica√ß√£o (0-10):** [Atribua uma nota e justifique brevemente].
                   - **Ponto Forte Principal:** [Identifique o principal acerto da estrat√©gia atual].
                   - **Ponto de Aten√ß√£o Cr√≠tico:** [Aponte o principal risco ou erro na aloca√ß√£o atual].

                **2. An√°lise de Riscos (Top 3):**
                   - **Risco 1:** [Descreva o risco].
                   - **Risco 2:** [Descreva o risco].
                   - **Risco 3:** [Descreva o risco].

                **3. Plano de A√ß√£o e Sugest√µes:**
                   - **Rebalanceamento:** [D√™ uma sugest√£o clara sobre quais posi√ß√µes devem ser aumentadas ou diminu√≠das para mitigar os riscos e otimizar os dividendos].
                   - **Sugest√£o de Ativo:** [Se aplic√°vel, sugira UM tipo de ativo/setor que est√° em falta e que fortaleceria a carteira, garantindo que seja negoci√°vel no Nubank].

                **4. Conclus√£o:**
                   - [Uma frase final de encorajamento e um resumo da principal a√ß√£o a ser tomada].

                Seja t√©cnico, mas com uma linguagem clara e direta.
            `;
            
            copyPromptToClipboardAndOpenGemini(prompt, document.getElementById('aiModalTitle'), document.getElementById('aiResult'));
        }

        async function suggestAssetWithAI() {
            syncStateWithDOM();
            const existingAssets = assetsState.map(a => a.name).join(', ');
            const portfolioData = assetsState.map(asset => ({
                ativo: asset.name,
                segmento: asset.segment,
                percentual_alvo: (asset.targetPct * 100).toFixed(2) + '%'
            }));

            const prompt = `
                Atue como um analista de investimentos (CFA) focado no mercado brasileiro de FIIs e Fiagros. A carteira do investidor Ciro, que busca altos dividendos mensais e investe pelo Nubank, √© a seguinte:
                ${JSON.stringify(portfolioData, null, 2)}

                **Sua Tarefa:**
                1.  Identifique o setor (Tijolo, Papel ou Fiagro) que est√° mais sub-alocado ou que oferece a melhor oportunidade de diversifica√ß√£o para esta carteira.
                2.  Sugira UM √öNICO ativo (FII ou Fiagro) negociado no Nubank dentro desse setor que seja uma excelente adi√ß√£o. N√£o sugira nenhum dos seguintes ativos que j√° est√£o na carteira: ${existingAssets}.
                3.  Compare o ativo sugerido com um outro ativo popular do mesmo setor, explicando por que a sua sugest√£o √© mais adequada para este investidor.

                **Forne√ßa sua resposta estritamente no seguinte formato:**

                **Setor Priorit√°rio:** [Nome do Setor]

                **Ativo Sugerido:** [TICKER]
                - **P/VP:** [Valor]
                - **DY (12M):** [Valor]
                - **Liquidez Di√°ria:** [Valor]
                - **Justificativa:** [Justificativa concisa (2-3 frases) explicando por que este ativo √© uma boa escolha para ESTA carteira espec√≠fica].

                **Comparativo:**
                - **[TICKER SUGERIDO] vs. [TICKER CONCORRENTE]:** [Explique brevemente por que o ativo sugerido √© superior ao concorrente neste contexto].
            `;

            copyPromptToClipboardAndOpenGemini(prompt, document.getElementById('aiModalTitle'), document.getElementById('aiResult'));
        }

        async function suggestFixedIncomeWithAI() {
            syncStateWithDOM();
            const portfolioData = assetsState.map(asset => ({
                ativo: asset.name,
                segmento: asset.segment,
                percentual_alvo: (asset.targetPct * 100).toFixed(2) + '%'
            }));

            const prompt = `
                Atue como um consultor financeiro. O investidor Ciro possui a seguinte carteira de renda vari√°vel focada em dividendos e investe atrav√©s do Nubank:
                ${JSON.stringify(portfolioData, null, 2)}

                Sugira DUAS op√ß√µes de investimentos em RENDA FIXA que sejam adequadas para este investidor, focando em produtos que s√£o comumente encontrados na plataforma do Nubank (como CDBs, LCIs/LCAs, e Tesouro Direto).

                **Sua resposta deve seguir estritamente o seguinte formato:**

                **Op√ß√£o 1: Reserva de Oportunidade (Alta Liquidez)**
                - **Produto Sugerido:** [Ex: Tesouro Selic, CDB de liquidez di√°ria do Nubank, Nu Reserva Imediata]
                - **Justificativa:** [Explique em 1-2 frases por que este produto √© ideal para ter dinheiro dispon√≠vel para aproveitar quedas no mercado de renda vari√°vel].

                **Op√ß√£o 2: Estabilidade e Prote√ß√£o (Longo Prazo)**
                - **Produto Sugerido:** [Ex: Tesouro IPCA+ com juros semestrais, CDB/LCI/LCA prefixado ou atrelado ao IPCA dispon√≠vel no Nubank]
                - **Justificativa:** [Explique em 1-2 frases como este produto protege o poder de compra contra a infla√ß√£o e pode gerar uma renda complementar est√°vel].
            `;
            copyPromptToClipboardAndOpenGemini(prompt, document.getElementById('aiModalTitle'), document.getElementById('aiResult'));
        }

        async function suggestOtherAssetsWithAI() {
            syncStateWithDOM();
            const portfolioData = assetsState.map(asset => ({
                ativo: asset.name,
                segmento: asset.segment,
                percentual_alvo: (asset.targetPct * 100).toFixed(2) + '%'
            }));

            const prompt = `
                Atue como um consultor financeiro. O investidor Ciro possui a seguinte carteira de renda vari√°vel focada em dividendos e investe atrav√©s do Nubank:
                ${JSON.stringify(portfolioData, null, 2)}

                Sugira DUAS op√ß√µes de investimentos em OUTRAS CLASSES DE ATIVOS (como A√ß√µes de crescimento, ETFs, BDRs ou Criptomoedas) que sejam negoci√°veis no Nubank para diversificar e complementar esta carteira.

                **Sua resposta deve seguir estritamente o seguinte formato:**

                **Op√ß√£o 1: Potencial de Crescimento do Capital (Brasil)**
                - **Classe/Ativo Sugerido:** [Ex: A√ß√µes de uma empresa espec√≠fica (ex: NU), ETF BOVA11]
                - **Papel na Carteira:** [Explique em 1-2 frases como este ativo pode adicionar um componente de valoriza√ß√£o de capital para equilibrar a estrat√©gia de renda].

                **Op√ß√£o 2: Dolariza√ß√£o e Diversifica√ß√£o Global**
                - **Classe/Ativo Sugerido:** [Ex: BDR de uma empresa estrangeira (ex: AAPL34), ETF IVVB11, Nu Renda Ibov Smart Dividendos]
                - **Papel na Carteira:** [Explique em 1-2 frases como este ativo pode proteger parte do patrim√¥nio contra a desvaloriza√ß√£o do Real e dar exposi√ß√£o a mercados internacionais].
            `;
            copyPromptToClipboardAndOpenGemini(prompt, document.getElementById('aiModalTitle'), document.getElementById('aiResult'));
        }

        async function optimizeTargetWithAI() {
            syncStateWithDOM();
            const portfolioData = assetsState.map(asset => ({
                ativo: asset.name,
                segmento: asset.segment,
                percentual_alvo_atual: (asset.targetPct * 100).toFixed(2) + '%'
            }));

            const prompt = `
                Atue como um gestor de portf√≥lio (CFA) especializado em estrat√©gias de renda para investidores brasileiros, considerando que os investimentos s√£o feitos pela plataforma Nubank.

                A seguir est√° a aloca√ß√£o alvo ATUAL da carteira do investidor Ciro, que √© focada em dividendos mensais. Ele deseja uma sugest√£o de rebalanceamento ESTRAT√âGICO, ou seja, uma nova distribui√ß√£o de porcentagens alvo para otimizar a diversifica√ß√£o e o potencial de renda, mantendo os mesmos ativos.

                **Aloca√ß√£o Alvo Atual:**
                ${JSON.stringify(portfolioData, null, 2)}

                **Sua Tarefa:**
                Proponha uma NOVA aloca√ß√£o de '% Alvo' para estes mesmos ativos. A soma das novas porcentagens deve ser exatamente 100%. Apresente a sua sugest√£o em formato de tabela e, em seguida, escreva uma breve justificativa (2-3 frases) para as principais mudan√ßas que voc√™ prop√¥s, focando em reduzir a concentra√ß√£o e melhorar a rela√ß√£o risco/retorno para dividendos.

                **Forne√ßa sua resposta estritamente no seguinte formato:**

                **Nova Sugest√£o de Aloca√ß√£o Alvo:**
                | Ativo | % Alvo Sugerido |
                |---|---|
                | NOME_ATIVO_1 | XX.XX% |
                | NOME_ATIVO_2 | XX.XX% |
                | ... | ... |

                **Justificativa Estrat√©gica:**
                [Texto da justificativa].
            `;

            copyPromptToClipboardAndOpenGemini(prompt, document.getElementById('aiModalTitle'), document.getElementById('aiResult'));
        }
        
        // CORRE√á√ÉO: L√≥gica do painel de compra r√°pida
        document.getElementById('quickAddForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const assetName = document.getElementById('quickAddAssetName').value.toUpperCase();
            const assetQty = parseInt(document.getElementById('quickAddAssetQty').value);

            if (!assetName || isNaN(assetQty) || assetQty <= 0) {
                alert('Por favor, preencha o nome do ativo e uma quantidade v√°lida.');
                return;
            }

            const assetToUpdate = assetsState.find(a => a.name === assetName);

            if (assetToUpdate) {
                assetToUpdate.myQty += assetQty;
                renderTable();
                calculatePortfolio();
                // Limpa os campos ap√≥s o sucesso
                document.getElementById('quickAddAssetName').value = '';
                document.getElementById('quickAddAssetQty').value = '';
            } else {
                alert(`Ativo "${assetName}" n√£o encontrado na sua carteira. Adicione-o primeiro atrav√©s do bot√£o "Adicionar Novo Ativo".`);
            }
        });

        function updateAssetDatalist() {
            const datalist = document.getElementById('asset-list');
            datalist.innerHTML = '';
            assetsState.forEach(asset => {
                const option = document.createElement('option');
                option.value = asset.name;
                datalist.appendChild(option);
            });
        }


        window.onload = () => {
            loadStateFromLocalStorage();
            renderTable();
            calculatePortfolio();
        };
    </script>
</body>
</html>
