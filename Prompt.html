<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criador de Prompts Profissional (v17)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #F9FAFB; padding-bottom: 250px; }
        .step { display: none; }
        .step.active { display: block; }
        .option-card { background-color: #1F2937; border: 2px solid #374151; transition: all 0.2s ease-in-out; display: flex; flex-direction: column; justify-content: space-between; }
        .option-card:hover { border-color: #4f46e580; transform: translateY(-2px); }
        .option-card.selected { border-color: #4F46E5; background-color: #3730a3; }
        .color-swatch { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease-in-out; }
        .color-swatch:hover, .color-swatch.selected { border-color: #F9FAFB; transform: scale(1.1); }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1F2937; }
        ::-webkit-scrollbar-thumb { background: #4F46E5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4338CA; }
        .toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #10B981; color: white; padding: 12px 24px; border-radius: 8px; z-index: 100; opacity: 0; transition: opacity 0.5s, transform 0.5s; pointer-events: none; }
        .toast-notification.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast-notification.error { background-color: #E53E3E; }
        #tech-sheet-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background-color: #1F2937;
            border-top: 1px solid #374151; 
            z-index: 50; 
            transition: transform 0.3s ease-in-out; 
            transform: translateY(100%); 
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.25);
        }
        #tech-sheet-bar.visible { transform: translateY(0); }
        #tech-sheet-content {
            max-height: 220px;
            overflow-y: auto;
            padding-right: 8px;
        }
        .tech-sheet-entry { 
            background-color: #374151;
            padding: 6px 12px; 
            border-radius: 9999px;
            font-size: 0.875rem; 
            white-space: nowrap; 
        }
        .tech-sheet-entry.clickable { cursor: pointer; transition: background-color 0.2s; }
        .tech-sheet-entry.clickable:hover { background-color: #4b5563; }
        .weight-controls {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #374151;
        }
        .weight-btn {
            background-color: #4f46e5;
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            font-size: 1.25rem;
            transition: background-color 0.2s;
        }
        .weight-btn:hover { background-color: #6366f1; }
        .weight-value { font-size: 1rem; font-weight: 600; min-width: 40px; text-align: center; }
         #loadingOverlay {
            position: absolute;
            inset: 0;
            background-color: rgba(17, 24, 39, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1rem; /* Corresponds to rounded-2xl */
            z-index: 20;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 max-w-4xl mx-auto">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">Criador de Prompts Profissional</h1>
            <p class="text-lg text-gray-400">Controle cada detalhe da sua criação com um fluxo inteligente.</p>
        </header>

        <!-- Main Content -->
        <div class="w-full">
            <!-- Progress Bar -->
            <div class="w-full bg-gray-700 rounded-full h-2.5 mb-8">
                <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
            </div>

            <main id="prompt-builder" class="bg-gray-900 p-6 md:p-8 rounded-2xl shadow-2xl min-h-[500px] relative">
                 <div id="loadingOverlay" class="hidden">
                    <svg class="animate-spin h-10 w-10 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p id="loadingText" class="text-xl text-white">Processando...</p>
                </div>
                <!-- Steps will be dynamically generated here -->
            </main>
        </div>
    </div>

    <!-- Tech Sheet Bar -->
    <div id="tech-sheet-bar" class="p-4">
        <div class="container mx-auto flex flex-col sm:flex-row items-start gap-4">
            <div class="flex-grow w-full overflow-hidden">
                <div class="flex justify-between items-center mb-3 px-2">
                    <h2 class="text-lg font-semibold text-white">Ficha Técnica (Clique para editar)</h2>
                    <button onclick="toggleTechSheet()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
                </div>
                <div id="tech-sheet-content" class="flex flex-wrap gap-2">
                    <!-- Dynamic content here -->
                </div>
            </div>
            <div class="flex-shrink-0 w-full sm:w-auto mt-4 sm:mt-0">
                <button id="regenerateButton" onclick="triggerFinalGeneration(true)" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors hidden items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                    Gerar Novo Prompt
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast-notification"></div>

    <script>
    // =================================================================================
    // DATA STORE: All steps, options, and logic are defined here.
    // =================================================================================
    const stepsData = {
        0: {
            title: "Como você quer começar?",
            type: 'start',
            autoPrompt: {
                title: "Prompt Automático Inteligente",
            }
        },
        1: {
            title: "Qual é a base da sua imagem?",
            type: 'category',
            key: 'baseCategory',
            options: [
                { label: "Fotorealista", description: "Crie imagens que parecem fotografias reais.", value: "photo", nextStep: 2 },
                { label: "Ilustração", description: "Crie arte com estilos visuais distintos.", value: "illustration", nextStep: 2 },
            ]
        },
        2: {
            title: "Escolha o Estilo Específico",
            type: 'single-choice-category',
            key: 'baseStyle',
            nextStep: 3,
            categories: {
                photo: [
                    { label: "Retrato em Estúdio", value: "Studio portrait, neutral background, controlled lighting, full focus on the subject" }, { label: "Retrato Ambiental", value: "Environmental portrait, background in focus showing the environment" },
                    { label: "Cinematográfico", value: "Cinematic style, film-inspired composition, dramatic colors and lighting" }, { label: "Golden Hour", value: "Golden hour photo, soft golden light at sunrise/sunset" },
                    { label: "Noir / P&B", value: "Noir style, black and white, high contrast, deep shadows, dramatic mood" }, { label: "Fotografia de Rua", value: "Street photography, candid urban scene with a documentary vibe" },
                    { label: "Documental", value: "Documentary/journalistic style, raw, unretouched, realistic" }, { label: "Foto de Moda", value: "Fashion photography, stylized composition, clothing highlighted" },
                    { label: "Lifestyle / Cotidiano", value: "Lifestyle photography, natural and candid daily scenes" }, { label: "Produto / Still Life", value: "Product/still life photography, clean background or controlled setting" },
                    { label: "Macro Fotografia", value: "Macro photography, extreme close-up of small details" }, { label: "Arquitetura", value: "Architectural photography, facades, interiors, clean lines" },
                    { label: "Paisagem Natural", value: "Natural landscape photography, mountains, beaches, forests" }, { label: "Vintage / Analógico", value: "Vintage/analog photography style, simulates old photographic film" },
                    { label: "Neon / Noturno", value: "Neon/urban night photography, urban scenes at night with neon and reflections" }, { label: "Silhueta / Contra-luz", value: "Silhouette/backlit photography, dark subject with a light background" },
                    { label: "Bokeh Estilizado", value: "Stylized bokeh photography, blurred background with rounded light points" }, { label: "Drone / Vista Aérea", value: "Drone/aerial view photography, top-down perspective, patterns and geometry" },
                    { label: "Subaquática", value: "Underwater photography, bluish light and water effects" }, { label: "Editorial Dramático", value: "Dramatic cinematic editorial, dark background, intense expressions, high emotion" },
                ],
                illustration: [
                    { label: "Comic Americano", value: "Classic American comic book style, strong lines, vibrant colors", styleKey: 'comic-classic' }, { label: "Comic Noir / Pulp", value: "Noir/pulp comic style, dark, inspired by 40s-50s noir comics", styleKey: 'comic-noir' },
                    { label: "Manga Shonen", value: "Shonen manga style, dynamic Japanese style with a focus on action", styleKey: 'manga-shonen' }, { label: "Manga Shojo", value: "Shojo manga style, delicate and romantic, large eyes and soft glows", styleKey: 'manga-shojo' },
                    { label: "Estilo Ghibli", value: "Ghibli studio style, soft painting, cozy and natural scenes", styleKey: 'ghibli' }, { label: "Anime Cyberpunk", value: "Cyberpunk anime style, futuristic Japanese style, inspired by Akira", styleKey: 'anime-cyberpunk' },
                    { label: "Fantasia Épica", value: "Epic fantasy concept art, environments and creatures from magical worlds", styleKey: 'fantasy-concept' }, { label: "Sci-Fi Conceitual", value: "Sci-fi concept art, futuristic cities, spaceships, and technology", styleKey: 'scifi-concept' },
                    { label: "Steampunk", value: "Steampunk art, retro-futurism with gears and steam", styleKey: 'steampunk' }, { label: "Pixel Art", value: "Pixel art style, retro with visible pixels", styleKey: 'pixel' },
                    { label: "Low Poly", value: "Low poly style, simplified 3D look with geometric shapes", styleKey: 'low-poly' }, { label: "Pintura a Óleo", value: "Classic oil painting style, traditional museum look", styleKey: 'oil-painting' },
                    { label: "Aquarela", value: "Traditional watercolor style, soft washes, diffuse edges", styleKey: 'watercolor' }, { label: "Sketch a Lápis", value: "Pencil sketch style, quick and detailed graphite drawing", styleKey: 'pencil-sketch' },
                    { label: "Vetor Flat", value: "Flat vector art, simple shapes and solid colors", styleKey: 'vector' }, { label: "Pop Art", value: "Pop art style, inspired by Andy Warhol and Roy Lichtenstein", styleKey: 'pop-art' },
                    { label: "Infantil / Fofa", value: "Childrens art / cute illustration style, simple lines, rounded shapes", styleKey: 'kids' }, { label: "Chibi", value: "Chibi style, miniaturized characters with large heads", styleKey: 'chibi' },
                    { label: "Cartoon Ocidental", value: "Western cartoon style, like Looney Tunes or The Simpsons", styleKey: 'western-cartoon' }, { label: "Minimalista", value: "Monochromatic minimalist art, simple shapes and focus on composition", styleKey: 'minimalist' },
                ]
            }
        },
        3: {
            title: "Nome e Idade da Personagem",
            subtitle: "Comece dando um nome e uma idade para sua personagem. A idade é opcional.",
            type: 'text-input',
            inputs: [
                { id: 'characterName', placeholder: 'Digite o nome da personagem', key: 'name', type: 'text' },
                { id: 'characterAge', placeholder: 'Digite a idade (opcional)', key: 'age', type: 'number' }
            ],
            nextLogic: (data) => data.age ? 5 : 4
        },
        4: {
            title: "Faixa Etária",
            type: 'single-choice',
            key: 'age',
            nextStep: 5,
            options: [
                { label: "Garota", value: "a girl, approximately 18-22 years old" }, { label: "Jovem Mulher", value: "a young woman, approximately 23-30 years old" },
                { label: "Mulher", value: "a woman, approximately 31-45 years old" }, { label: "Mulher Madura", value: "a mature woman, approximately 46+ years old" },
            ]
        },
        5: {
            title: "Nacionalidades e Ascendências",
            type: 'single-choice-sections',
            key: 'ethnicity',
            nextStep: 6,
            sections: [
                { title: "Américas", options: [ { label: "Brasileiro / Brasileira", value: "Brazilian" }, { label: "Americano / Americana", value: "American" }, { label: "Argentino / Argentina", value: "Argentinian" }, { label: "Boliviano / Boliviana", value: "Bolivian" }, { label: "Canadense", value: "Canadian" }, { label: "Chileno / Chilena", value: "Chilean" }, { label: "Colombiano / Colombiana", value: "Colombian" }, { label: "Cubano / Cubana", value: "Cuban" }, { label: "Equatoriano / Equatoriana", value: "Ecuadorian" }, { label: "Haitiano / Haitiana", value: "Haitian" }, { label: "Mexicano / Mexicana", value: "Mexican" }, { label: "Paraguaio / Paraguaia", value: "Paraguayan" }, { label: "Peruano / Peruana", value: "Peruvian" }, { label: "Uruguaio / Uruguaia", value: "Uruguayan" }, { label: "Venezuelano / Venezuelana", value: "Venezuelan" } ] },
                { title: "Europa", options: [ { label: "Espanhol / Espanhola", value: "Spanish" }, { label: "Alemão / Alemã", value: "German" }, { label: "Belga", value: "Belgian" }, { label: "Britânico / Britânica", value: "British" }, { label: "Croata", value: "Croatian" }, { label: "Dinamarquês / Dinamarquesa", value: "Danish" }, { label: "Francês / Francesa", value: "French" }, { label: "Grego / Grega", value: "Greek" }, { label: "Holandês / Holandesa", value: "Dutch" }, { label: "Irlandês / Irlandesa", value: "Irish" }, { label: "Italiano / Italiana", value: "Italian" }, { label: "Polonês / Polonesa", value: "Polish" }, { label: "Português / Portuguesa", value: "Portuguese" }, { label: "Romeno / Romena", value: "Romanian" }, { label: "Russo / Russa", value: "Russian" }, { label: "Sueco / Sueca", value: "Swedish" }, { label: "Suíço / Suíça", value: "Swiss" }, { label: "Ucraniano / Ucraniana", value: "Ukrainian" } ] },
                { title: "Ásia", options: [ { label: "Chinês / Chinesa", value: "Chinese" }, { label: "Japonês / Japonesa", value: "Japanese" }, { label: "Afegão / Afegã", value: "Afghan" }, { label: "Coreano / Coreana", value: "Korean" }, { label: "Filipino / Filipina", value: "Filipino" }, { label: "Indiano / Indiana", value: "Indian" }, { label: "Indonésio / Indonésia", value: "Indonesian" }, { label: "Iraniano / Iraniana", value: "Iranian" }, { label: "Iraquiano / Iraquiana", value: "Iraqi" }, { label: "Israelense", value: "Israeli" }, { label: "Libanês / Libanesa", value: "Lebanese" }, { label: "Paquistanês / Paquistanesa", value: "Pakistani" }, { label: "Palestino / Palestina", value: "Palestinian" }, { label: "Sírio / Síria", value: "Syrian" }, { label: "Tailandês / Tailandesa", value: "Thai" }, { label: "Turco / Turca", value: "Turkish" }, { label: "Vietnamita", value: "Vietnamese" } ] },
                { title: "África", options: [ { label: "Angolano / Angolana", value: "Angolan" }, { label: "Argelino / Argelina", value: "Algerian" }, { label: "Cabo-verdiano / Cabo-verdiana", value: "Cape Verdean" }, { label: "Congolês / Congolesa", value: "Congolese" }, { label: "Egípcio / Egípcia", value: "Egyptian" }, { label: "Ganês / Ganesa", value: "Ghanaian" }, { label: "Marroquino / Marroquina", value: "Moroccan" }, { label: "Moçambicano / Moçambicana", value: "Mozambican" }, { label: "Nigeriano / Nigeriana", value: "Nigerian" }, { label: "Senegalês / Senegalesa", value: "Senegalese" }, { label: "Sul-africano / Sul-africana", value: "South African" } ] },
                { title: "Oceania", options: [ { label: "Australiano / Australiana", value: "Australian" }, { label: "Neozelandês / Neozelandesa", value: "New Zealander" } ] }
            ],
            finalOption: { label: "Nenhum", value: "" }
        },
        6: {
            title: "Biotipo Físico",
            type: 'single-choice',
            key: 'bodyType',
            nextStep: 7,
            options: [
                { label: "Magra / Magrinha", value: "thin body, low body fat" }, { label: "Magrela", value: "extremely thin body" },
                { label: "Fina / Delgada", value: "slender, elegant, and slim body" }, { label: "Cheinha / Fofinha", value: "chubby, soft body with some body fat" },
                { label: "Gorda / Gordinha", value: "fat, plump body with plenty of body fat" }, { label: "Plus Size", value: "plus-size body type" },
                { label: "Robusta / Forte", value: "robust, strong, wide body frame" }, { label: "Sarada", value: "toned body with well-defined muscles and low fat" },
                { label: "Malhada", value: "fit body, toned from working out" }, { label: "Definida", value: "defined body with visible muscles" },
                { label: "Musculosa", value: "muscular body with large muscle volume" }, { label: "Atlética", value: "athletic body, functional and strong" },
                { label: "Curvilínea Acentuada", value: "very voluptuous and curvy body" }, { label: "Silhueta Ampulheta", value: "hourglass figure, very curvy body with wide hips and bust, and a thin waist" },
                { label: "Voluptuosa", value: "voluptuous, curvy and attractive body" }, { label: "Curvilínea", value: "curvaceous, voluptuous body with full shapes" },
                { label: "Nenhum", value: "" },
            ]
        },
        7: {
            title: "Cor da Pele",
            type: 'single-choice',
            key: 'skinColor',
            nextStep: 8,
            options: [
                { label: "Pele Clara", value: "light, rosy skin tone" }, { label: "Pele Pálida", value: "pale, very light skin" },
                { label: "Pele Bronzeada", value: "tanned, golden skin tone" }, { label: "Pele Oliva", value: "olive, yellowish/greenish skin tone" },
                { label: "Pele Escura", value: "dark brown skin tone" }, { label: "Pele com Sardas", value: "skin with freckles" },
                { label: "Nenhum", value: "" },
            ]
        },
        8: {
            title: "Comprimento do Cabelo",
            type: 'single-choice',
            key: 'hairLength',
            nextStep: 9,
            options: [
                { label: "Longo", value: "long hair", filterKey: "long" }, { label: "Médio", value: "medium hair", filterKey: "medium" },
                { label: "Curto", value: "short hair", filterKey: "short" }, { label: "Raspado", value: "shaved hair", filterKey: "shaved" },
                { label: "Nenhum", value: "", filterKey: "all" },
            ]
        },
        9: {
            title: "Corte de Cabelo e Penteado",
            type: 'single-choice-filtered',
            key: 'hairStyle',
            filterOn: 'hairLength',
            nextStep: 10,
            options: [
                { label: "Corte em Camadas", value: "long layers", filterKey: "long" }, { label: "Corte Reto", value: "long blunt cut", filterKey: "long" },
                { label: "Shaggy Hair", value: "long shaggy hair", filterKey: "long" }, { label: "Franja Cortininha", value: "curtain bangs", filterKey: "long" },
                { label: "Rabo de Cavalo Alto", value: "high polished ponytail", filterKey: "long" }, { label: "Ondas Sereia", value: "mermaid waves", filterKey: "long" },
                { label: "Meio Preso", value: "half-up hairstyle", filterKey: "long" }, { label: "Trança Boxeadora", value: "double boxer braids", filterKey: "long" },
                { label: "Franja Reta e Cheia", value: "long hair with full straight bangs", filterKey: "long" }, { label: "Efeito Molhado", value: "wet look hairstyle", filterKey: "long" },
                { label: "Long Bob (Lob)", value: "long bob (lob)", filterKey: "medium" }, { label: "Chanel de Bico", value: "A-line bob", filterKey: "medium" },
                { label: "Blunt Cut", value: "medium blunt cut", filterKey: "medium" }, { label: "Shaggy", value: "medium shaggy hair", filterKey: "medium" },
                { label: "Clavicut", value: "clavicut", filterKey: "medium" }, { label: "Ondas Suaves", value: "soft beach waves", filterKey: "medium" },
                { label: "Liso com Divisão Central", value: "sleek straight hair with a center part", filterKey: "medium" }, { label: "Glass Hair", value: "glass hair look", filterKey: "medium" },
                { label: "Pixie Cut", value: "classic pixie cut", filterKey: "short" }, { label: "Short Bob (Chanel)", value: "short bob", filterKey: "short" },
                { label: "Bixie Cut", value: "bixie cut", filterKey: "short" }, { label: "Topete (Pompadour)", value: "pompadour hairstyle", filterKey: "short" },
                { label: "Slicked Back", value: "slicked back short hair", filterKey: "short" }, { label: "Franja Curta", value: "short hair with baby bangs", filterKey: "short" },
                { label: "Undercut", value: "female undercut", filterKey: "short" }, { label: "Buzz Cut Uniforme", value: "uniform buzz cut", filterKey: "shaved" },
                { label: "Buzz Cut com Degradê", value: "buzz cut with a fade", filterKey: "shaved" }, { label: "Careca", value: "completely bald, razor shaved", filterKey: "shaved" },
                { label: "Hair Tattoo", value: "hair tattoo, razor designs", filterKey: "shaved" }, { label: "Nenhum / Não especificar", value: "", filterKey: "all" },
            ]
        },
        10: {
            title: "Cor do Cabelo",
            type: 'single-choice',
            key: 'hairColor',
            nextStep: 11,
            manualInput: { id: 'hairColorManual', placeholder: 'Detalhes adicionais (ex: mechas azuis...)', key: 'hairColorDetails' },
            options: [
                { label: "Preto", value: "black hair" }, { label: "Loiro", value: "blonde hair" }, { label: "Castanho", value: "brown hair" },
                { label: "Ruivo", value: "red hair" }, { label: "Branco/Platinado", value: "white/platinum hair" }, { label: "Rosa", value: "pink hair" },
                { label: "Azul", value: "blue hair" }, { label: "Verde", value: "green hair" }, { label: "Nenhum", value: "" },
            ]
        },
        11: {
            title: "Cor dos Olhos",
            type: 'single-choice',
            key: 'eyeColor',
            nextStep: 12,
            options: [
                { label: "Azuis Claros", value: "light blue eyes" }, { label: "Azuis Escuros", value: "dark blue eyes" },
                { label: "Verdes Claros", value: "light green eyes" }, { label: "Verdes Escuros", value: "dark green eyes" },
                { label: "Castanhos Claros", value: "light brown eyes" }, { label: "Castanhos Escuros", value: "dark brown eyes" },
                { label: "Cor de Mel", value: "honey-colored eyes" }, { label: "Cinza Claro", value: "light gray eyes" },
                { label: "Cinza Escuro", value: "dark gray eyes" }, { label: "Pretos", value: "black eyes" },
                { label: "Heterocromia", value: "heterochromia eyes" }, { label: "Nenhum", value: "" },
            ]
        },
        12: {
            title: "Tamanho dos Seios",
            type: 'single-choice',
            key: 'breasts',
            nextStep: 13,
            options: [
                { label: "Reto (Flat)", value: "flat chest" }, { label: "Pequenos", value: "small breasts" },
                { label: "Médios", value: "medium breasts" }, { label: "Grandes", value: "large breasts" },
                { label: "Volumosos", value: "voluminous breasts" }, { label: "Nenhum", value: "" },
            ]
        },
        13: {
            title: "Composição da Cena",
            type: 'multi-choice-sections',
            nextStep: 14,
            sections: [
                {
                    title: "Orientação da Personagem",
                    key: 'characterView',
                    type: 'multi',
                    options: [
                        { label: "De Frente", value: "facing the camera" }, { label: "De Lado", value: "side view" }, { label: "De Costas", value: "from behind" },
                    ]
                },
                {
                    title: "Enquadramento e Composição (Múltipla Escolha)",
                    key: 'sceneComposition',
                    type: 'multi',
                    options: [
                        { label: "Corpo Inteiro", value: "full body shot, long shot" }, { label: "Plano Médio", value: "medium shot" },
                        { label: "Close-up no Rosto", value: "close-up shot on face" }, { label: "Plano Detalhe", value: "extreme close-up on a detail" },
                        { label: "Ângulo Baixo", value: "low angle shot" }, { label: "Ângulo Alto", value: "high angle shot" },
                        { label: "Ângulo Holandês", value: "dutch angle" }, { label: "Ponto de Vista (POV)", value: "point of view (POV)" },
                        { label: "Sobre o Ombro", value: "over the shoulder shot" }, { label: "Plano Americano", value: "american shot, medium long shot" },
                        { label: "Plano Geral Amplo", value: "establishing shot, wide shot" }, { label: "Plano Conjunto", value: "two-shot or group shot" },
                        { label: "Regra dos Terços", value: "rule of thirds composition" }, { label: "Linhas Guia", value: "leading lines composition" },
                        { label: "Enquadramento Natural", value: "frame within a frame composition" }, { label: "Simetria e Ponto Central", value: "symmetrical composition, centered subject" },
                        { label: "Espaço Negativo", value: "negative space composition" }, { label: "Profundidade de Campo", value: "shallow depth of field or deep depth of field" },
                        { label: "Visão Macro", value: "macro view" }, { label: "Enquadramento com Foco", value: "focused framing" },
                        { label: "Enquadramento Centralizado", value: "centered framing" }, { label: "Visão Inferior", value: "shot from a low angle, looking up" },
                    ]
                }
            ]
        },
        14: {
            title: "Estilo da Personagem",
            type: 'single-choice',
            key: 'characterStyle',
            nextStep: 15,
            options: [
                { label: "Fantasia: Elfa", value: "fantasy elf style" }, { label: "Fantasia: Guerreira", value: "fantasy warrior style" },
                { label: "Sci-Fi: Cyberpunk", value: "sci-fi cyberpunk style" }, { label: "Sci-Fi: Androide", value: "sci-fi android style" },
                { label: "Moderno: Gótica", value: "modern gothic style" }, { label: "Moderno: E-girl", value: "modern e-girl style" },
                { label: "Moderno: Fitness", value: "modern fitness style" }, { label: "Moderno: Casual", value: "modern casual style" },
                { label: "Histórico: Vitoriano", value: "historical victorian style" }, { label: "Histórico: Medieval", value: "historical medieval style" },
                { label: "Steampunk", value: "steampunk style" }, { label: "Pós-apocalíptico", value: "post-apocalyptic style" },
                { label: "Nenhum", value: "" },
            ]
        },
        15: {
            title: "Maquiagem",
            type: 'single-choice',
            key: 'makeup',
            nextStep: 16,
            options: [
                { label: "Natural", value: "natural makeup" }, { label: "Olho Esfumado", value: "smokey eyes makeup" },
                { label: "Glamour", value: "glamour makeup" }, { label: "Gótica", value: "gothic makeup" },
                { label: "Cores Neon", value: "neon colors makeup" }, { label: "Artística", value: "artistic makeup" },
                { label: "Nenhuma", value: "no makeup" },
            ]
        },
        16: {
            title: "Acessórios",
            subtitle: "(múltipla escolha)",
            type: 'multi-choice-sections-toggle',
            key: 'accessories',
            nextStep: 17,
            sections: [
                {
                    title: "Gótica",
                    options: [
                        { label: "Choker de Veludo", value: "velvet choker" }, { label: "Harness de Couro", value: "leather harness" },
                        { label: "Cinto com Fivela Elaborada", value: "belt with ornate buckle" }, { label: "Correntes para Calças", value: "pants chains" },
                        { label: "Luvas de Renda/Arrastão", value: "lace or fishnet gloves" }, { label: "Colares de Crucifixo/Ankh", value: "crucifix or ankh necklaces" },
                        { label: "Anéis com Pedras Escuras", value: "rings with dark stones" }, { label: "Brincos de Argola com Cruz", value: "hoop earrings with cross pendants" },
                        { label: "Meia-calça Arrastão/Vitoriana", value: "fishnet or victorian pattern tights" }, { label: "Bolsa de Caixão", value: "coffin-shaped bag" },
                        { label: "Broches de Camafeu/Insetos", value: "cameo or insect brooches" }, { label: "Chapéu de Aba Larga/Cartola", value: "wide-brimmed hat or top hat" },
                        { label: "Óculos de Sol Vintage", value: "round vintage sunglasses" }, { label: "Pulseira de Couro com Spikes", value: "leather bracelet with spikes" },
                        { label: "Acessórios de Cabelo com Penas", value: "hair accessories with black feathers" }, { label: "Gargantilha com Spikes", value: "spiked garter" },
                        { label: "Leg-harness", value: "leg harness" }, { label: "Piercings (Septo, Lábio)", value: "septum or lip piercing" },
                        { label: "Ankle Boots com Plataforma", value: "platform ankle boots" }, { label: "Véus", value: "short or long veils" },
                    ]
                },
                {
                    title: "Rockeira",
                    options: [
                        { label: "Jaqueta de Couro Perfecto", value: "perfecto leather jacket" }, { label: "Bandanas", value: "bandana" },
                        { label: "Cinto de Couro com Tachas", value: "studded leather belt" }, { label: "Pulseiras de Couro com Rebites", value: "leather wristbands with rivets" },
                        { label: "Munhequeiras", value: "band logo wristbands" }, { label: "Colar com Palheta", value: "guitar pick necklace" },
                        { label: "Anéis de Caveira", value: "silver skull rings" }, { label: "Correntes Grossas", value: "thick chains" },
                        { label: "Óculos de Sol Aviador", value: "aviator sunglasses" }, { label: "Botas de Combate", value: "combat boots" },
                        { label: "Patches de Bandas", value: "band patches on jacket" }, { label: "Boné Trucker", value: "trucker hat" },
                        { label: "Meias Arrastão", value: "fishnet stockings" }, { label: "Brincos de Argola Grandes", value: "large hoop earrings" },
                        { label: "Lenços de Caveira/Xadrez", value: "skull or plaid scarf" }, { label: "Luvas sem Dedos", value: "fingerless leather gloves" },
                        { label: "Carteira com Corrente", value: "wallet with chain" }, { label: "Cinto de Lona", value: "canvas belt with metal buckle" },
                        { label: "Tornozeleiras de Corrente", value: "chain anklets" }, { label: "Pins de Bandas", value: "band pins" },
                    ]
                },
                {
                    title: "Sadomasoquista",
                    options: [
                        { label: "Harness de Corpo Inteiro", value: "full body harness" }, { label: "Coleira de Couro", value: "leather collar with O-ring" },
                        { label: "Algemas", value: "leather or metal cuffs" }, { label: "Mordaças", value: "ball gag or tape gag" },
                        { label: "Chicotes", value: "whip or riding crop" }, { label: "Máscaras", value: "leather or latex mask" },
                        { label: "Cinto de Castidade", value: "aesthetic chastity belt" }, { label: "Gag de Anel", value: "ring gag" },
                        { label: "Body Chains", value: "heavy metal body chains" }, { label: "Luvas de Látex", value: "elbow-length latex gloves" },
                        { label: "Meias 7/8 de Vinil", value: "vinyl thigh-high stockings with garter belt" }, { label: "Pasties", value: "nipple pasties" },
                        { label: "Cuffs de Couro", value: "wide leather cuffs" }, { label: "Correntes de Coleira", value: "leash chains" },
                        { label: "Piercings Estratégicos", value: "nipple or genital piercings" }, { label: "Botas de Cano Altíssimo", value: "thigh-high stiletto boots" },
                        { label: "Espartilho de Couro/Vinil", value: "leather or vinyl corset" }, { label: "Tapa-olho de Couro", value: "leather eyepatch" },
                        { label: "Plugue de Cauda", value: "aesthetic tail plug" }, { label: "Joias para o Corpo", value: "body jewelry with chains" },
                    ]
                },
                {
                    title: "Patricinha",
                    options: [
                        { label: "Bolsa de Grife", value: "designer handbag" }, { label: "Tiara Acolchoada/Pérolas", value: "padded or pearl headband" },
                        { label: "Laços de Fita", value: "ribbon bows in hair" }, { label: "Óculos de Sol Grandes", value: "large designer sunglasses" },
                        { label: "Colar de Inicial", value: "initial pendant necklace" }, { label: "Pulseira de Berloques", value: "charm bracelet" },
                        { label: "Brincos de Pérola/Brilhantes", value: "pearl or diamond stud earrings" }, { label: "Relógio de Marca", value: "gold-plated watch" },
                        { label: "Lenço de Seda", value: "designer silk scarf" }, { label: "Cinto Fino de Couro", value: "thin leather belt" },
                        { label: "Sapatilhas", value: "ballet flats" }, { label: "Scarpins", value: "high-heeled pumps" },
                        { label: "Presilhas com Strass", value: "rhinestone hair clips" }, { label: "Anéis Delicados", value: "delicate stackable rings" },
                        { label: "Porta-celular de Grife", value: "designer phone case with chain" }, { label: "Necessaire de Marca", value: "designer makeup bag" },
                        { label: "Chaveiro de Pelúcia", value: "plush keychain" }, { label: "Faixas de Cabelo", value: "fabric headbands" },
                        { label: "Meias-calças Finas", value: "sheer neutral-colored tights" }, { label: "Luvas de Couro Curtas", value: "short leather gloves in pastel colors" },
                    ]
                }
            ]
        },
        17: {
            title: "Expressão Facial",
            subtitle: "(Múltipla Escolha)",
            type: 'multi-choice',
            key: 'facialExpression',
            nextStep: 18,
            options: [
                { label: "Sedutora", value: "seductive expression" }, { label: "Confiante", value: "confident expression" },
                { label: "Triste", value: "sad expression" }, { label: "Irritada", value: "angry expression" },
                { label: "Feliz/Sorrindo", value: "happy, smiling expression" }, { label: "Pensativa", value: "thoughtful expression" },
                { label: "Assustada", value: "scared expression" }, { label: "Entediada", value: "bored expression" },
                { label: "Meiga", value: "sweet, gentle expression" }, { label: "Fofinha", value: "cute expression" },
                { label: "Gritando", value: "shouting, screaming expression" }, { label: "Chorando", value: "crying expression" },
                { label: "Lágrimas", value: "with tears in eyes" },
            ]
        },
        18: {
            title: "Pose Corporal",
            subtitle: "(Múltipla Escolha)",
            type: 'multi-choice-sections',
            nextStep: 19,
            manualInput: { id: 'bodyPoseManual', placeholder: 'Ou escreva a pose aqui...', key: 'manualPose' },
            sections: [
                { title: "Poses Básicas e Cotidianas", key: 'bodyPose', type: 'multi', options: [ { label: "Em pé", value: "standing pose" }, { label: "Sentada(o)", value: "sitting pose" }, { label: "Deitada(o)", value: "lying down pose" }, { label: "Andando", value: "walking pose" }, { label: "Correndo", value: "running pose" }, { label: "Dançando", value: "dancing pose" }, { label: "Encostada(o)", value: "leaning pose" }, { label: "Agachada(o)", value: "squatting pose" }, ] },
                { title: "Poses de Ação e Movimento", key: 'bodyPose', type: 'multi', options: [ { label: "Pose de Luta", value: "fighting stance" }, { label: "Pose de Ação", value: "action pose (jumping, climbing)" }, { label: "Pose de Super-herói", value: "superhero pose" }, { label: "Ajoelhada(o)", value: "kneeling pose" }, ] },
                { 
                    title: "Poses Sensuais e Provocantes", 
                    key: 'bodyPose', 
                    type: 'multi', 
                    options: [ 
                        { label: "De Quatro", value: "on all fours" }, { label: "Pernas Abertas", value: "legs spread" }, { label: "Bunda Empinada para Trás", value: "butt pushed back" },
                        { label: "Foco na Bunda", value: "focus on the ass" }, { label: "Foco na Vagina", value: "focus on pussy" }, { label: "Vagina Aberta", value: "spread pussy" },
                        { label: "Vagina Fechada", value: "closed pussy" }, { label: "Pernas Cruzadas", value: "crossed legs" }, { label: "Ajoelhada (sensual)", value: "kneeling" },
                        { label: "Masturbação", value: "masturbating" }, { label: "Dedos na Vagina", value: "fingers in pussy" }, { label: "Dedos no Ânus", value: "fingers in anus" },
                        { label: "Puxando a Roupa", value: "pulling on clothing" }, { label: "Arco nas Costas (Arching Back)", value: "arching back pose, standing or lying down, enhancing body curves" },
                        { label: "Olhar por Cima do Ombro", value: "looking over the shoulder, back to the camera, creating a mysterious and inviting mood" }, { label: "Reclinada no Sofá", value: "reclining on a sofa or bed, relaxed body, conveying comfort and sensuality" },
                        { label: "Jack-O' Pose", value: "Jack-O' pose, on all fours with chest on the ground and hips raised high, face often turned to the camera" }, { label: "Mãos na Nuca", value: "hands behind head, sitting or lying down, arms raised, elongating the torso" },
                        { label: "Pernas para Cima", value: "legs up pose, lying on back with legs straight up, possibly against a wall" }, { label: "Abraço por Trás", value: "embrace from behind, focusing on intimacy and the touch of hands" },
                        { label: "Sentada com Joelhos Dobrados", value: "sitting on the floor hugging knees to chest, suggesting intimate vulnerability" }, { label: "Silhueta na Janela", value: "silhouette in a window, dark body against a bright window, focusing on contour" },
                        { label: "Alongamento Matinal", value: "morning stretch pose, stretching in bed as if just waking up, natural and intimate" }, { label: "Contrapposto Sensual", value: "sensual contrapposto pose, weight on one leg, accentuating hip shape" },
                        { label: "Molhada pela Chuva", value: "drenched in rain, clothes clinging to the body, dramatic aesthetic" }, { label: "Segurando um Lençol", value: "holding a sheet to strategically cover the body" },
                        { label: "Deitada de Bruços", value: "lying on stomach, propped up on elbows, relaxed and casually attractive pose" }, { label: "Pose Pin-up Clássica", value: "classic pin-up pose, inspired by 50s illustrations" },
                        { label: "Tocando os Lábios", value: "touching the lips gently with a finger, drawing focus to the mouth" }, { label: "Dança Íntima", value: "slow dance pose, two people close together, focusing on connection" },
                        { label: "Ajoelhada de Costas", value: "kneeling, back view, focusing on the line of the back and hips" }, { label: "Saindo da Água", value: "emerging from water, body partially submerged, water dripping from skin" },
                        { label: "Equilíbrio em um Pé", value: "balancing on one foot, dynamic and elegant pose" }, { label: "Bunda com quadril empinado para cima", value: "ass with hips pushed up" },
                        { label: "De bruços, seios no chão", value: "lying on stomach, breasts pressed to the floor" }, { label: "De bruços, apoiada nos cotovelos", value: "lying on stomach, propped on elbows" },
                        { label: "De quatro, peito no chão", value: "on all fours, chest on the ground" }, { label: "Quadril levantado para o alto", value: "hips raised high" },
                        { label: "Rosto para frente, quadril para trás", value: "face forward, hips back" }
                    ] 
                },
                { title: "Poses Expressivas e Artísticas", key: 'bodyPose', type: 'multi', options: [ { label: "Pose de Yoga", value: "yoga pose (e.g., lotus, warrior)" }, { label: "Contorcionismo", value: "contortionist pose" }, { label: "Pose Fetal", value: "fetal position" }, { label: "Abraçando a si mesma(o)", value: "hugging self" }, ] }
            ]
        },
        19: {
            title: "Tipo de Vestimenta",
            type: 'single-choice',
            key: 'clothing',
            nextLogic: (data) => data.clothing?.value === 'nude' || data.clothing?.value === 'clothed' ? 26 : 20,
            options: [
                { label: "Totalmente Nua", value: "nude" }, { label: "Apenas Roupa Íntima", value: "underwear" }, { label: "Vestida", value: "clothed" },
            ]
        },
        20: {
            title: "Tipo de Calcinha",
            type: 'single-choice',
            key: 'pantiesType',
            nextStep: 21,
            manualInput: { id: 'pantiesManual', placeholder: 'Ou escreva os detalhes aqui...', key: 'pantiesDetails' },
            options: [
                { label: "Clássica", value: "classic cut panties" }, { label: "Biquíni", value: "bikini cut panties" }, { label: "Caleçon", value: "boyshort panties" },
                { label: "Cintura Alta", value: "high-waist panties" }, { label: "Fio Dental", value: "thong" }, { label: "Tanga", value: "tanga panties" },
                { label: "Strappy", value: "strappy panties" }, { label: "Asa Delta", value: "high-leg or V-cut panties" }, { label: "Sem Costura", value: "seamless panties" },
                { label: "De Renda", value: "lace panties" }, { label: "Aberta", value: "crotchless panties" },
            ]
        },
        21: {
            title: "Tamanho da Calcinha",
            type: 'single-choice',
            key: 'pantiesSize',
            nextStep: 22,
            options: [
                { label: "Extra Pequeno (XS)", value: "XS size" }, { label: "Pequeno (S)", value: "S size" }, { label: "Médio (M)", value: "M size" },
                { label: "Largo (L)", value: "L size" }, { label: "Extra Largo (XL)", value: "XL size" }, { label: "Nenhum", value: "" },
            ]
        },
        22: {
            title: "Cor e Detalhes da Calcinha",
            type: 'color-picker',
            key: 'pantiesColor',
            nextStep: 23,
            manualInput: { id: 'pantiesDetails', placeholder: 'Ex: azul claro com renda, transparente...', key: 'pantiesDetails' }
        },
        23: {
            title: "Tipo de Sutiã",
            type: 'single-choice',
            key: 'braType',
            nextLogic: (data) => data.braType?.value === 'topless' ? 26 : 24,
            manualInput: { id: 'braManual', placeholder: 'Ou escreva os detalhes aqui...', key: 'braType' },
            options: [
                { label: "Meia-taça", value: "demi-cup bra" }, { label: "Push-up", value: "push-up bra" }, { label: "Balconet", value: "balconette bra" },
                { label: "Alta Sustentação", value: "high support bra" }, { label: "Tomara que Caia", value: "strapless bra" }, { label: "Nadador", value: "racerback bra" },
                { label: "Triângulo", value: "triangle bra" }, { label: "Bralette", value: "bralette" }, { label: "Esportivo", value: "sports bra" },
                { label: "Decote Profundo", value: "plunge bra" }, { label: "Cropped", value: "cropped bra" }, { label: "Strappy", value: "strappy bra" },
                { label: "Nenhum (Topless)", value: "topless" },
            ]
        },
        24: {
            title: "Tamanho do Sutiã",
            type: 'single-choice',
            key: 'braSize',
            nextStep: 25,
            options: [
                { label: "Extra Pequeno (XS)", value: "XS size" }, { label: "Pequeno (S)", value: "S size" }, { label: "Médio (M)", value: "M size" },
                { label: "Largo (L)", value: "L size" }, { label: "Extra Largo (XL)", value: "XL size" }, { label: "Nenhum", value: "" },
            ]
        },
        25: {
            title: "Cor e Detalhes do Sutiã",
            type: 'color-picker',
            key: 'braColor',
            nextStep: 26,
            manualInput: { id: 'braDetails', placeholder: 'Ex: azul claro com renda, transparente...', key: 'braDetails' }
        },
        26: {
            title: "Iluminação / Textura do Papel",
            type: 'conditional-choice',
            condition: (data) => data.baseCategory?.value === 'photo',
            nextStep: 27,
            true: { // Lighting
                title: "Iluminação",
                key: 'lighting',
                type: 'single-choice',
                options: [
                    { label: "Cinematográfica", value: "cinematic lighting" }, { label: "Luz Suave", value: "soft light" }, { label: "Luz Dura", value: "hard light" },
                    { label: "Luz de Rembrandt", value: "Rembrandt lighting" }, { label: "Contraluz", value: "backlight" }, { label: "Golden Hour", value: "golden hour lighting" },
                    { label: "Luz de Velas", value: "candlelight" }, { label: "Neon", value: "neon lighting" }, { label: "Luz Subaquática", value: "underwater lighting" },
                    { label: "Luz de Recorte", value: "rim light, kicker" }, { label: "Silhueta", value: "silhouette" }, { label: "Nenhum (Escuridão)", value: "" },
                ]
            },
            false: { // Paper Texture
                title: "Tipo de Papel / Textura",
                key: 'paperTexture',
                type: 'single-choice',
                options: []
            }
        },
        27: {
            title: "Fundo / Local",
            type: 'single-choice',
            key: 'background',
            nextStep: 28,
            manualInput: { id: 'backgroundManual', placeholder: 'Ou escreva os detalhes aqui...', key: 'background' },
            options: [
                { label: "Estúdio", value: "in a studio with a plain gray background" }, { label: "Floresta Mística", value: "in a mystical forest" },
                { label: "Cidade Cyberpunk", value: "in a cyberpunk city" }, { label: "Quarto Aconchegante", value: "in a cozy room" },
                { label: "Praia Ensolarada", value: "on a sunny beach" }, { label: "Biblioteca Antiga", value: "in an old library" },
                { label: "Ruínas Desertas", value: "in deserted ruins" }, { label: "Salão de Baile Gótico", value: "in a gothic ballroom" },
                { label: "Nave Espacial", value: "inside a spaceship" },
            ]
        },
        28: {
            title: "Ação da Personagem",
            type: 'multi-choice',
            key: 'action',
            isFinalStep: true,
            manualInput: { id: 'actionManual', placeholder: 'Ou escreva os detalhes aqui...', key: 'manualAction' },
            options: [
                { label: "Olhando para a câmera", value: "looking at the camera" }, { label: "Ajustando a roupa", value: "adjusting clothes" },
                { label: "Interagindo com o cenário", value: "interacting with the scenery" }, { label: "Em movimento", value: "in motion" },
                { label: "Pensativa", value: "thoughtful" }, { label: "Tocando um instrumento", value: "playing an instrument" },
                { label: "Pintando em uma tela", value: "painting on a canvas" }, { label: "Bebendo café", value: "drinking coffee" },
                { label: "Olhando para o horizonte", value: "looking at the horizon" },
            ]
        },
        29: { // Final prompt display step
            title: "Seu Prompt Profissional está Pronto!",
            subtitle: "Copie o prompt e use-o no seu gerador de imagens. Para máxima consistência, use o mesmo \"Código de Consistência\" em todas as imagens.",
            type: 'final-display',
        }
    };

    const paperOptions = {
        'comic-classic': { label: 'Papel Offset Branco (90-120 g/m²)', value: 'on heavy white offset paper or smooth Bristol board texture' }, 'comic-noir': { label: 'Papel Jornal (Newsprint)', value: 'on newsprint paper texture' },
        'manga-shonen': { label: 'Papel Offset Branco (80-100 g/m²)', value: 'on standard white manga paper' }, 'manga-shojo': { label: 'Papel Offset Extra-Branco', value: 'on extra-white smooth offset paper for fine lines' },
        'ghibli': { label: 'Papel Aquarela (Cold Press)', value: 'on cold press watercolor paper or textured gouache paper' }, 'anime-cyberpunk': { label: 'Papel Liso (Simulação Digital)', value: 'on a smooth digital illustration surface simulating hot press paper' },
        'fantasy-concept': { label: 'Papel Aquarela (Hot Press)', value: 'on hot press watercolor paper or acrylic painting paper' }, 'scifi-concept': { label: 'Papel para Marcadores (Marker Paper)', value: 'on smooth marker paper or Bristol board' },
        'steampunk': { label: 'Papel Kraft ou Sépia', value: 'on brown kraft paper or textured sepia-toned paper' }, 'pixel': { label: 'Papel Couchê Fosco', value: 'printed on high-resolution matte coated paper' },
        'low-poly': { label: 'Papel Couchê Brilhante', value: 'printed on glossy coated paper to enhance colors' }, 'oil-painting': { label: 'Tela de Algodão ou Linho', value: 'on cotton or linen canvas texture' },
        'watercolor': { label: 'Papel Aquarela 100% Algodão', value: 'on 100% cotton cold or hot press watercolor paper (300 g/m²)' }, 'pencil-sketch': { label: 'Papel de Esboço (Sketchbook)', value: 'on sketchbook paper with a slight texture' },
        'vector': { label: 'Papel Couchê Fosco', value: 'printed on matte coated or smooth offset paper' }, 'pop-art': { label: 'Papel Couchê Brilhante', value: 'printed on glossy coated paper for vibrant colors' },
        'kids': { label: 'Papel Canson Colorido', value: 'on colored Canson paper or white offset paper (120 g/m²)' }, 'chibi': { label: 'Papel para Marcadores', value: 'on smooth marker paper for flat colors' },
        'western-cartoon': { label: 'Papel Bristol', value: 'on white offset paper (100-120 g/m²) or Bristol board' }, 'minimalist': { label: 'Papel Algodão Liso', value: 'on smooth cotton paper or printmaking paper' }
    };

    const colors = [
        { name: 'Branco', hex: '#FFFFFF', value: 'white' }, { name: 'Preto', hex: '#000000', value: 'black' }, { name: 'Cinza', hex: '#808080', value: 'gray' },
        { name: 'Vermelho', hex: '#FF0000', value: 'red' }, { name: 'Laranja', hex: '#FFA500', value: 'orange' }, { name: 'Amarelo', hex: '#FFFF00', value: 'yellow' },
        { name: 'Verde', hex: '#008000', value: 'green' }, { name: 'Azul', hex: '#0000FF', value: 'blue' }, { name: 'Roxo', hex: '#800080', value: 'purple' },
        { name: 'Rosa', hex: '#FFC0CB', value: 'pink' }, { name: "Marrom", value: "brown", hex: "#A52A2A" }, { name: "Bege", value: "beige", hex: "#F5F5DC" },
        { name: 'Dourado', hex: '#FFD700', value: 'gold' }, { name: 'Prata', hex: '#C0C0C0', value: 'silver' }, { name: 'Ciano', hex: '#00FFFF', value: 'cyan' },
        { name: 'Magenta', hex: '#FF00FF', value: 'magenta' }, { name: 'Verde Limão', hex: '#32CD32', value: 'lime green' }, { name: 'Azul Marinho', hex: '#000080', value: 'navy blue' }
    ];

    // =================================================================================
    // APPLICATION STATE & DOM ELEMENTS
    // =================================================================================
    let promptData = {};
    let currentStep = 0;
    let isFinalPromptGenerated = false;
    let isEditingFromTechSheet = false;
    const totalStepsBeforeFinal = 28;

    const mainContainer = document.getElementById('prompt-builder');
    const progressBar = document.getElementById('progressBar');
    const techSheetBar = document.getElementById('tech-sheet-bar');
    const techSheetContent = document.getElementById('tech-sheet-content');
    const regenerateButton = document.getElementById('regenerateButton');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');

    const sidebarLabels = {
        baseCategory: 'Base', baseStyle: 'Estilo', paperTexture: 'Textura', name: 'Nome', age: 'Idade',
        ethnicity: 'Etnia', bodyType: 'Biotipo', skinColor: 'Pele', hairLength: 'Cabelo (Comp.)',
        hairStyle: 'Cabelo (Penteado)', hairColor: 'Cabelo (Cor)', hairColorDetails: 'Cabelo (Detalhes)', eyeColor: 'Olhos', breasts: 'Seios',
        makeup: 'Maquiagem', accessories: 'Acessórios', facialExpression: 'Expressão', bodyPose: 'Pose',
        clothing: 'Vestimenta', pantiesType: 'Calcinha', pantiesSize: 'Calcinha (Tam.)', pantiesColor: 'Calcinha (Cor)',
        pantiesDetails: 'Calcinha (Detalhes)', braType: 'Sutiã', braSize: 'Sutiã (Tam.)', braColor: 'Sutiã (Cor)',
        braDetails: 'Sutiã (Detalhes)', lighting: 'Iluminação', background: 'Fundo', action: 'Ação',
        characterView: 'Orientação', sceneComposition: 'Composição', manualPose: 'Pose Manual', manualAction: 'Ação Manual'
    };

    // =================================================================================
    // CORE LOGIC: Rendering, Navigation, Selection
    // =================================================================================

    function createOptionCard(option, stepData) {
        const card = document.createElement('div');
        card.className = 'option-card p-4 rounded-lg cursor-pointer';
        card.dataset.key = option.key || stepData.key;
        card.dataset.label = option.label;
        card.dataset.value = option.value;
        if (option.nextStep) card.dataset.nextStep = option.nextStep;
        if (option.styleKey) card.dataset.styleKey = option.styleKey;
        if (option.filterKey) card.dataset.filterKey = option.filterKey;
        
        const type = stepData.type || '';
        const isMulti = type.includes('multi');
        const isSingle = type.includes('single') || type.includes('category');

        if (isMulti) card.dataset.multi = 'true';
        if (isSingle) card.dataset.single = 'true';

        let content = `<div class="card-content flex-grow">
            <h3 class="font-bold text-lg">${option.label}</h3>`;
        if (option.description) {
            content += `<p class="text-sm text-gray-400 mt-1">${option.description}</p>`;
        }
        content += `</div>`;
        
        content += `<div class="weight-controls">
            <button class="weight-btn" data-action="decrease-weight" data-key="${card.dataset.key}" data-value="${option.value}">-</button>
            <span class="weight-value">1.0</span>
            <button class="weight-btn" data-action="increase-weight" data-key="${card.dataset.key}" data-value="${option.value}">+</button>
        </div>`;

        card.innerHTML = content;
        return card;
    }

    function renderStep(stepId) {
        const stepData = stepsData[stepId];
        if (!stepData) return;

        let stepHtml = `<div id="step-${stepId}" class="step">`;

        // Title and Subtitle
        stepHtml += `<h2 class="text-2xl font-semibold mb-2">${stepData.title}</h2>`;
        if (stepData.subtitle) {
            stepHtml += `<p class="text-gray-400 mb-6">${stepData.subtitle}</p>`;
        } else {
            stepHtml += `<div class="mb-6"></div>`;
        }
        
        const contentContainer = document.createElement('div');
        contentContainer.id = `step-content-${stepId}`;

        if (stepData.type === 'start') {
            contentContainer.innerHTML = `
                <div class="text-center">
                    <button class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-8 rounded-lg transition-colors text-lg" data-action="start-manual">Começar Manualmente</button>
                </div>
                <div class="my-8 border-t border-gray-700"></div>
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-center">${stepData.autoPrompt.title}</h3>
                    <p class="text-center text-gray-400 mb-6">Descreva sua ideia abaixo e a IA criará um prompt detalhado para você.</p>
                    
                    <h4 class="font-semibold text-indigo-400 mb-2 mt-6">Descreva sua ideia (aqui a mágica acontece):</h4>
                    <textarea id="autoPromptManual" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" placeholder="Ex: ilustração de uma elfa loira na floresta, estilo ghibli..."></textarea>
                                        
                    <button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors mt-6" data-action="generate-auto">Gerar Prompt Inteligente</button>
                </div>
            `;
        } else if (stepData.type === 'final-display') {
             contentContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                    <button id="copyButton" data-action="copy" data-target="finalPrompt" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>
                        <span class="copy-text">Copiar Prompt</span>
                    </button>
                    <button id="addConsistencyButton" data-action="add-consistency" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                        <span>Adicionar Consistência</span>
                    </button>
                    <button id="removeConsistencyButton" data-action="remove-consistency" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                        <span>Remover Consistência</span>
                    </button>
                </div>
                <textarea id="finalPrompt" rows="8" class="w-full p-4 bg-gray-800 border border-gray-700 rounded-lg text-gray-300"></textarea>
                <h3 class="text-xl font-semibold mb-2 mt-6">Prompt Negativo</h3>
                <textarea id="negativePrompt" rows="4" class="w-full p-4 bg-gray-800 border border-gray-700 rounded-lg text-gray-300"></textarea>
                <button data-action="copy" data-target="negativePrompt" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>
                    <span class="copy-text">Copiar Negativo</span>
                </button>
                <h3 class="text-xl font-semibold mb-2 mt-6">Código de Consistência (Seed)</h3>
                <div id="consistencySeed" class="w-full p-4 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 font-mono"></div>
                <button data-action="copy" data-target="consistencySeed" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>
                    <span class="copy-text">Copiar Código</span>
                </button>
                <div class="mt-8 flex items-center gap-4">
                    <button id="toggleTechSheetButton" onclick="toggleTechSheet()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        Ficha Técnica (Editar)
                    </button>
                    <button data-action="restart" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                        Começar de Novo
                    </button>
                </div>`;
        } else {
            // Navigation Buttons for regular steps
            const prevStep = getPreviousStep(stepId);
            const isFinal = stepData.isFinalStep;
            if (stepId > 0) {
                stepHtml += `<div class="mb-8 flex justify-between w-full">
                    <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors" data-action="prev" data-step="${prevStep}">Anterior</button>
                    ${!isFinal ? `<button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors" data-action="next">Próximo</button>` : ''}
                    ${isFinal ? `<button class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors" data-action="generate">Gerar Prompt</button>` : ''}
                </div>`;
            }

            if (stepData.type === 'text-input') {
                const inputsHtml = stepData.inputs.map(input =>
                    `<input type="${input.type}" id="${input.id}" data-key="${input.key}" placeholder="${input.placeholder}" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">`
                ).join('<div class="h-4"></div>');
                contentContainer.innerHTML = `<div class="space-y-4">${inputsHtml}</div>`;
            } else if (stepData.type === 'color-picker') {
                let colorHtml = `<div class="grid grid-cols-6 md:grid-cols-9 gap-3 mb-4">`;
                colorHtml += colors.map(color =>
                    `<div class="color-swatch" style="background-color: ${color.hex};" title="${color.name}" data-key="${stepData.key}" data-label="${color.name}" data-value="${color.value}" data-single="true"></div>`
                ).join('');
                colorHtml += `</div>`;
                contentContainer.innerHTML = colorHtml;
            } else if (stepData.type.includes('choice') || stepData.type === 'category') {
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 md:grid-cols-3 gap-4';

                if (stepId === 1) {
                    grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';
                }

                if (stepData.type === 'conditional-choice') {
                    const conditionResult = stepData.condition(promptData);
                    const choiceData = conditionResult ? stepData.true : stepData.false;
                    
                    if (choiceData.key === 'paperTexture') {
                        const styleKey = promptData.baseStyle?.styleKey;
                        if (styleKey && paperOptions[styleKey]) {
                            choiceData.options = [paperOptions[styleKey], { label: "Nenhum", value: "" }];
                        } else {
                            choiceData.options = [{ label: "Papel de Esboço", value: "on sketchbook paper" }, { label: "Nenhum", value: "" }];
                        }
                    }
                    
                    const titleElement = mainContainer.querySelector(`#step-${stepId} h2`);
                    if (titleElement) titleElement.textContent = choiceData.title;

                    choiceData.options.forEach(opt => grid.appendChild(createOptionCard(opt, choiceData)));
                } else if (stepData.type === 'single-choice-category') {
                    const categoryKey = promptData.baseCategory?.value;
                    if (categoryKey && stepData.categories[categoryKey]) {
                        stepData.categories[categoryKey].forEach(opt => grid.appendChild(createOptionCard(opt, stepData)));
                    } else {
                        console.error("Cannot render step 2: baseCategory not set. Returning to step 1.");
                        goToStep(1);
                        return;
                    }
                } else if (stepData.type === 'single-choice-filtered') {
                    const filterValue = promptData[stepData.filterOn]?.filterKey || 'all';
                    stepData.options.forEach(opt => {
                        if (opt.filterKey === 'all' || opt.filterKey === filterValue) {
                            grid.appendChild(createOptionCard(opt, stepData));
                        }
                    });
                } else if (stepData.type.includes('sections')) {
                    grid.className = 'space-y-6';
                    stepData.sections.forEach(section => {
                        const sectionDiv = document.createElement('div');
                        let sectionTitle = `<h3 class="text-xl font-semibold mb-4 text-indigo-400 border-b border-gray-700 pb-2">${section.title}</h3>`;
                        
                        if (stepData.type === 'multi-choice-sections-toggle') {
                            sectionTitle = `<div class="option-card p-4 rounded-lg cursor-pointer" data-action="toggle-section" data-target="section-${section.title.replace(/\s+/g, '')}"><h3 class="font-bold text-lg">${section.title}</h3></div>`;
                        }

                        const sectionGrid = document.createElement('div');
                        sectionGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4';
                        if (stepData.type === 'multi-choice-sections-toggle') {
                            sectionGrid.id = `section-${section.title.replace(/\s+/g, '')}`;
                            sectionGrid.className += ' mt-4 hidden';
                        }

                        section.options.forEach(opt => {
                            const cardKey = section.key || stepData.key;
                            let cardType = section.type || 'multi';
                            if (stepData.type === 'single-choice-sections') {
                                cardType = 'single';
                            }
                            const card = createOptionCard(opt, { key: cardKey, type: cardType });
                            sectionGrid.appendChild(card);
                        });
                        sectionDiv.innerHTML = sectionTitle;
                        sectionDiv.appendChild(sectionGrid);
                        grid.appendChild(sectionDiv);
                    });
                    if(stepData.finalOption) {
                        grid.appendChild(createOptionCard(stepData.finalOption, { ...stepData, type: 'single' }));
                    }
                } else {
                    stepData.options.forEach(opt => grid.appendChild(createOptionCard(opt, stepData)));
                }
                contentContainer.appendChild(grid);
            }

            if (stepData.manualInput) {
                const textarea = document.createElement('textarea');
                textarea.id = stepData.manualInput.id;
                textarea.placeholder = stepData.manualInput.placeholder;
                textarea.dataset.key = stepData.manualInput.key;
                textarea.className = "mt-4 w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none";
                contentContainer.appendChild(textarea);
            }
        }

        stepHtml += contentContainer.outerHTML;
        stepHtml += `</div>`;
        mainContainer.innerHTML = stepHtml;

        updateSelectionUI(stepId);
    }

    function updateSelectionUI(stepId) {
        const stepContent = document.getElementById(`step-${stepId}`);
        if (!stepContent) return;

        stepContent.querySelectorAll('.option-card').forEach(card => {
            const { key, value } = card.dataset;
            const data = promptData[key];
            let isSelected = false;
            let currentWeight = 1.0;

            if (Array.isArray(data)) {
                const item = data.find(item => item.value === value);
                if (item) {
                    isSelected = true;
                    currentWeight = item.weight;
                }
            } else if (data && data.value === value) {
                isSelected = true;
                currentWeight = data.weight;
            }
            
            const weightControls = card.querySelector('.weight-controls');

            if (isSelected) {
                card.classList.add('selected');
                const weightValueEl = card.querySelector('.weight-value');
                if (weightValueEl) weightValueEl.textContent = currentWeight.toFixed(1);
                
                if (isEditingFromTechSheet && weightControls) {
                    weightControls.style.display = 'flex';
                } else if (weightControls) {
                    weightControls.style.display = 'none';
                }

            } else {
                card.classList.remove('selected');
                if (weightControls) {
                    weightControls.style.display = 'none';
                }
            }
        });

        stepContent.querySelectorAll('.color-swatch').forEach(swatch => {
            const { key, value } = swatch.dataset;
            if (promptData[key]?.value === value) {
                swatch.classList.add('selected');
            } else {
                swatch.classList.remove('selected');
            }
        });

        stepContent.querySelectorAll('input, textarea').forEach(input => {
            const { key } = input.dataset;
            if (promptData[key]) {
                input.value = promptData[key].label;
            }
        });
    }

    function showStep(stepId) {
        const activeStep = document.querySelector('.step.active');
        if (activeStep) activeStep.classList.remove('active');
        
        let stepToShow = document.getElementById(`step-${stepId}`);
        if (!stepToShow) {
            renderStep(stepId);
            stepToShow = document.getElementById(`step-${stepId}`);
        }
        
        if (stepToShow) {
            stepToShow.classList.add('active');
            currentStep = stepId;
            updateProgressBar();
        }
    }

    function goToStep(stepId) {
        if (stepId > totalStepsBeforeFinal + 1 || stepId < 0) return;
        showStep(stepId);
    }
    
    function getPreviousStep(stepId) {
        if (stepId <= 1) return 0;
        if (stepId === 5 && promptData.ageIsNumeric) return 3;
        if (stepId === 26) {
            const clothingChoice = promptData.clothing?.value;
            if (clothingChoice === 'nude' || clothingChoice === 'clothed') return 19;
            if (promptData.braType?.value === 'topless') return 23;
            return 25;
        }
        return stepId - 1;
    }

    function updateProgressBar() {
        const progress = (Math.max(0, currentStep - 1) / totalStepsBeforeFinal) * 100;
        progressBar.style.width = `${Math.min(progress, 100)}%`;
    }
    
    function handleNextAction() {
        isEditingFromTechSheet = false;
        const stepData = stepsData[currentStep];
        if (!stepData) return;

        document.querySelectorAll(`#step-${currentStep} input, #step-${currentStep} textarea`).forEach(input => {
            const { key } = input.dataset;
            const value = input.value.trim();
            if (value) {
                promptData[key] = { label: value, value: value, weight: 1.0 };
                if (key === 'age') {
                    promptData.ageIsNumeric = true;
                    promptData.age.value = getAgeDescription(parseInt(value, 10));
                }
            } else {
                delete promptData[key];
                if (key === 'age') promptData.ageIsNumeric = false;
            }
        });
        
        updateTechSheet();

        let nextStep;
        if (typeof stepData.nextLogic === 'function') {
            nextStep = stepData.nextLogic(promptData);
        } else {
            nextStep = stepData.nextStep || currentStep + 1;
        }
        goToStep(nextStep);
    }
    
    function handleCardSelection(card) {
        const { key, label, value, styleKey, filterKey, multi, single, nextStep: cardNextStep } = card.dataset;
        
        if (multi === 'true') {
            if (!promptData[key]) promptData[key] = [];
            const index = promptData[key].findIndex(item => item.value === value);
            if (index > -1) {
                promptData[key].splice(index, 1);
            } else {
                promptData[key].push({ label, value, weight: 1.0 });
            }
        } else if (single === 'true') {
            const isAlreadySelected = card.classList.contains('selected');
            
            const stepContent = card.closest('.step');
            if (stepContent) {
                stepContent.querySelectorAll(`[data-key="${key}"]`).forEach(c => c.classList.remove('selected'));
            }

            if (!isAlreadySelected) {
                const data = { label, value, weight: 1.0 };
                if (styleKey) data.styleKey = styleKey;
                if (filterKey) data.filterKey = filterKey;
                promptData[key] = data;
            } else {
                delete promptData[key];
            }
        }
        
        updateTechSheet();
        updateSelectionUI(currentStep);

        if (!isEditingFromTechSheet && single === 'true' && !promptData[key]) {
            // Do nothing, allow deselection without auto-advancing
        } else if (!isEditingFromTechSheet && single === 'true') {
            setTimeout(() => {
                const stepData = stepsData[currentStep];
                let next;
                if (cardNextStep) {
                    next = parseInt(cardNextStep, 10);
                } else if (typeof stepData.nextLogic === 'function') {
                    next = stepData.nextLogic(promptData);
                } else {
                    next = stepData.nextStep || currentStep + 1;
                }
                goToStep(next);
            }, 250);
        }
    }

    function adjustWeight(key, value, amount) {
        const data = promptData[key];
        let item;
        if (Array.isArray(data)) {
            item = data.find(i => i.value === value);
        } else if (data && data.value === value) {
            item = data;
        }

        if (item) {
            item.weight = Math.max(0.1, Math.round((item.weight + amount) * 10) / 10);
            updateSelectionUI(currentStep);
            updateTechSheet();
        }
    }
    
    function triggerFinalGeneration(closeTechSheet = false) {
        if (closeTechSheet) {
            techSheetBar.classList.remove('visible');
        }
        const manualInputAction = document.getElementById('actionManual');
        if (manualInputAction) {
            const value = manualInputAction.value.trim();
            const key = manualInputAction.dataset.key;
            if (value) {
                promptData[key] = { label: value, value: value, weight: 1.0 };
            } else {
                delete promptData[key];
            }
        }
        updateTechSheet();
        generateAndDisplayManualPrompt();
    }

    mainContainer.addEventListener('click', (e) => {
        const target = e.target;
        const card = target.closest('.option-card');
        
        if (target.closest('[data-action="increase-weight"]')) {
            e.stopPropagation();
            const btn = target.closest('[data-action="increase-weight"]');
            adjustWeight(btn.dataset.key, btn.dataset.value, 0.1);
            return;
        }
        if (target.closest('[data-action="decrease-weight"]')) {
            e.stopPropagation();
            const btn = target.closest('[data-action="decrease-weight"]');
            adjustWeight(btn.dataset.key, btn.dataset.value, -0.1);
            return;
        }

        const actionTarget = target.closest('button, [data-action="toggle-section"], .color-swatch');
        if (card && !actionTarget) {
             handleCardSelection(card);
        } else if (actionTarget) {
            const { action, step, target: dataTarget } = actionTarget.dataset;
            if (action === 'prev') {
                isEditingFromTechSheet = false;
                goToStep(parseInt(step, 10));
            }
            else if (action === 'next') handleNextAction();
            else if (action === 'generate') triggerFinalGeneration();
            else if (action === 'restart') restart();
            else if (action === 'start-manual') goToStep(1);
            else if (action === 'generate-auto') handleAutoGenerate();
            else if (action === 'copy') copyToClipboard(dataTarget, actionTarget.querySelector('.copy-text'));
            else if (action === 'add-consistency') addConsistencyText();
            else if (action === 'remove-consistency') removeConsistencyText();
            else if (action === 'toggle-section') {
                document.getElementById(dataTarget).classList.toggle('hidden');
                actionTarget.classList.toggle('selected');
            } else if (actionTarget.matches('.color-swatch')) {
                handleCardSelection(actionTarget);
            }
        }
    });
    
    // =================================================================================
    // TECH SHEET & UI HELPERS
    // =================================================================================
    const TECH_SHEET_REDIRECT_MAP = { 8: 9, 1: 2 };

    function handleTechSheetClick(stepId) {
        isEditingFromTechSheet = true;
        let targetStep = TECH_SHEET_REDIRECT_MAP[stepId] || stepId;
        if (isFinalPromptGenerated) targetStep = stepId;
        goToStep(targetStep);
    }

    function toggleTechSheet() {
        techSheetBar.classList.toggle('visible');
    }

    function updateTechSheet() {
        const hasData = Object.keys(promptData).length > 0;
        if (!isFinalPromptGenerated && !hasData) {
            techSheetBar.classList.remove('visible');
            return;
        }

        techSheetContent.innerHTML = '';
        const displayOrder = ['ai_generated', ...Object.keys(sidebarLabels)];

        displayOrder.forEach(key => {
            const data = promptData[key];
            if (!data) return;

            const processEntry = (item) => {
                const weight = item.weight ? item.weight.toFixed(1) : '1.0';
                const label = sidebarLabels[key] || 'Gerado por IA';
                const valueText = weight !== '1.0' ? `${item.label} (${weight})` : item.label;
                const entry = document.createElement('div');
                entry.className = 'tech-sheet-entry';
                if (isFinalPromptGenerated && key !== 'ai_generated') {
                    entry.classList.add('clickable');
                    const stepId = Object.keys(stepsData).find(id => {
                        const s = stepsData[id];
                        if (s.key === key || s.manualInput?.key === key || s.sections?.some(sec => sec.key === key)) return true;
                        return false;
                    });
                    if(stepId) entry.dataset.step = stepId;
                }
                entry.innerHTML = `<span class="font-semibold text-indigo-400">${label}:</span> ${valueText}`;
                techSheetContent.appendChild(entry);
            };

            if (Array.isArray(data)) data.forEach(processEntry);
            else if (typeof data === 'object' && data.label) processEntry(data);
        });

        regenerateButton.style.display = isFinalPromptGenerated ? 'flex' : 'none';
    }
    
    techSheetContent.addEventListener('click', (e) => {
        const entry = e.target.closest('.tech-sheet-entry');
        if (entry && entry.dataset.step) {
            handleTechSheetClick(parseInt(entry.dataset.step, 10));
        }
    });

    function getAgeDescription(age) {
        if (age >= 46) return `a mature woman, approximately ${age} years old`;
        if (age >= 31) return `a woman, approximately ${age} years old`;
        if (age >= 23) return `a young woman, approximately ${age} years old`;
        if (age >= 18) return `a girl, approximately ${age} years old`;
        return `${age} years old`;
    }
    
    function showToast(message, duration = 3000, isError = false) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast-notification';
        if (isError) toast.classList.add('error');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
    }
    
    function copyToClipboard(elementId, textElement) {
        const element = document.getElementById(elementId);
        const textToCopy = element.tagName === 'TEXTAREA' ? element.value : element.innerText;
        const originalText = textElement.textContent;

        const textArea = document.createElement('textarea');
        textArea.value = textToCopy;
        textArea.style.position = 'fixed';
        textArea.style.top = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();

        try {
            document.execCommand('copy');
            textElement.textContent = 'Copiado!';
            showToast('Copiado para a área de transferência!');
        } catch (err) {
            textElement.textContent = 'Falha ao copiar';
            showToast('Falha ao copiar.', 3000, true);
        }

        document.body.removeChild(textArea);
        setTimeout(() => { textElement.textContent = originalText; }, 2000);
    }
    
    function restart() {
        promptData = {};
        isFinalPromptGenerated = false;
        isEditingFromTechSheet = false;
        techSheetBar.classList.remove('visible');
        updateTechSheet();
        goToStep(0);
    }
    
    // =================================================================================
    // PROMPT GENERATION LOGIC
    // =================================================================================
    function formatValue(item) {
        if (!item || !item.value) return '';
        const weight = item.weight || 1.0;
        return weight !== 1.0 ? `(${item.value}:${weight.toFixed(1)})` : item.value;
    }

    function buildInitialPrompt(includeConsistency = false) {
        const p = promptData;
        const segments = [];

        if (p.baseStyle) segments.push(formatValue(p.baseStyle) + ',');
        
        let charDesc = p.baseCategory?.value === 'illustration' ? `an illustration of` : `a portrait of`;
        const charParts = [p.name?.value, p.age?.value, p.ethnicity?.value, p.characterStyle ? `with a ${formatValue(p.characterStyle)}` : null].filter(Boolean);
        if (charParts.length > 0) charDesc += ` ${charParts.join(', ')}`;
        segments.push(`${charDesc}.`);

        const hairColorDesc = [formatValue(p.hairColor), formatValue(p.hairColorDetails)].filter(Boolean).join(' ');
        const hairStyleDesc = p.hairStyle ? `${p.hairStyle.label} (${formatValue(p.hairStyle)})` : formatValue(p.hairLength);
        const physicalFeatures = [formatValue(p.bodyType), formatValue(p.skinColor), formatValue(p.breasts), hairStyleDesc, hairColorDesc, formatValue(p.eyeColor)].filter(Boolean);
        if (physicalFeatures.length > 0) segments.push(`She has ${physicalFeatures.join(', ')}.`);

        if (p.clothing) {
            if (p.clothing.value === 'nude') segments.push('She is completely nude.');
            else if (p.clothing.value === 'underwear') {
                const underwearParts = [];
                if (p.braType?.value === 'topless') underwearParts.push('topless');
                else if (p.braType) {
                    const braDesc = p.braType.label.includes('(') ? formatValue(p.braType) : `${p.braType.label} (${formatValue(p.braType)})`;
                    const braDetails = [formatValue(p.braColor), formatValue(p.braDetails), braDesc, formatValue(p.braSize)].filter(Boolean).join(' ');
                    underwearParts.push(`wearing a ${braDetails}`);
                }
                if (p.pantiesType) {
                    const pantiesDesc = p.pantiesType.label.includes('(') ? formatValue(p.pantiesType) : `${p.pantiesType.label} (${formatValue(p.pantiesType)})`;
                    const pantiesDetails = [formatValue(p.pantiesColor), formatValue(p.pantiesDetails), pantiesDesc, formatValue(p.pantiesSize)].filter(Boolean).join(' ');
                    underwearParts.push(underwearParts.length > 0 ? `and a pair of ${pantiesDetails}` : `wearing a pair of ${pantiesDetails}`);
                }
                if (underwearParts.length > 0) segments.push(`She is ${underwearParts.join(' ')}.`);
            } else if (p.clothing.value === 'clothed') segments.push('She is fully clothed.');
        }
        
        const extraDetails = [];
        if (p.accessories?.length > 0) extraDetails.push(`accessorized with ${p.accessories.map(formatValue).join(', ')}`);
        if (p.makeup) extraDetails.push(`wearing ${formatValue(p.makeup)}`);
        if (extraDetails.length > 0) segments.push(`She is ${extraDetails.join(' and ')}.`);

        const poseParts = [];
        if (p.characterView?.length > 0) poseParts.push(...p.characterView.map(formatValue));
        const allPoses = [...(p.bodyPose?.map(formatValue) || []), formatValue(p.manualPose)].filter(Boolean);
        if (allPoses.length > 0) poseParts.push(`in a ${allPoses.join(', ')} pose`);
        if (p.facialExpression?.length > 0) poseParts.push(`with a ${p.facialExpression.map(formatValue).join(', ')} expression`);
        if (poseParts.length > 0) segments.push(`Posed ${poseParts.join(', ')}.`);
        
        const allActions = [...(p.action?.map(formatValue) || []), formatValue(p.manualAction)].filter(Boolean);
        const environment = [formatValue(p.background), allActions.length > 0 ? `while ${allActions.join(', ')}` : null].filter(Boolean);
        if (environment.length > 0) segments.push(`The scene is ${environment.join(' ')}.`);
        
        const finalDetails = [
            p.baseCategory?.value === 'photo' ? formatValue(p.lighting) : formatValue(p.paperTexture),
            ...(p.sceneComposition?.map(formatValue) || []),
            p.baseCategory?.value === 'photo' ? 'realistic photography, photorealistic, 8k, ultra-detailed' : null
        ].filter(Boolean);
        if(finalDetails.length > 0) segments.push(finalDetails.join(', ') + '.');
        
        if (includeConsistency) {
            segments.push(generateConsistencyText());
        }

        return segments.join(' ').replace(/\s+/g, ' ').replace(/ \./g, '.').replace(/ ,/g, ',').trim();
    }
    
    function generateConsistencyText() {
        const p = promptData;
        const consistencyParts = [p.name?.value, p.age?.value, p.ethnicity?.value, p.hairColor?.value, p.hairStyle?.value || p.hairLength?.value, p.eyeColor?.value, p.bodyType?.value].filter(Boolean).map(s => s.split(',')[0]); 
        return consistencyParts.length > 2 ? `(character sheet for consistency: ${consistencyParts.join(', ')})` : '';
    }

    function addConsistencyText() {
        const promptTextarea = document.getElementById('finalPrompt');
        const consistencyText = generateConsistencyText();
        if (consistencyText && !promptTextarea.value.includes(consistencyText)) {
            promptTextarea.value += ` ${consistencyText}`;
            showToast("Texto de consistência adicionado!");
        } else if (!consistencyText) {
            showToast("Não há dados suficientes para gerar o texto de consistência.", 3000, true);
        }
    }

    function removeConsistencyText() {
        const promptTextarea = document.getElementById('finalPrompt');
        const originalText = promptTextarea.value;
        const newText = originalText.replace(/\s*\(character sheet for consistency:.*?\)/g, '').trim();
        
        if (originalText !== newText) {
            promptTextarea.value = newText;
            showToast("Texto de consistência removido!");
        } else {
            showToast("Nenhum texto de consistência para remover.", 3000, true);
        }
    }
    
    // Fallback negative prompt generator
    function generateNegativePrompt(data) {
        const baseNegative = "deformed, bad anatomy, disfigured, poorly drawn face, mutation, mutated, extra limb, ugly, poorly drawn hands, missing limb, floating limbs, disconnected limbs, malformed hands, blurry, ((((mutated hands and fingers)))), watermark, watermarked, oversaturated, censored, distorted hands, amputation, missing hands, obese, doubled face, doubled hands, text, signature";
        const dynamicNegatives = new Set();
        if (data.baseCategory?.value === 'photo') 'painting, drawing, illustration, anime, cartoon, 3d render, sketch'.split(',').forEach(term => dynamicNegatives.add(term.trim()));
        else if (data.baseCategory?.value === 'illustration') 'photo, photograph, photorealistic, 3d render, realism'.split(',').forEach(term => dynamicNegatives.add(term.trim()));
        return [baseNegative, ...Array.from(dynamicNegatives)].join(', ');
    }

    async function generateNegativePromptWithAPI(positivePrompt) {
        const systemPrompt = `Based on the following positive prompt for an AI image generator, create a concise, comma-separated, all-lowercase negative prompt in English. The negative prompt should include common negative terms (like bad anatomy, ugly, deformed, blurry, watermark, text, signature) and also include specific terms that contradict the positive prompt's style and subject (e.g., if the positive prompt is 'photorealistic', the negative should include 'painting, illustration, 3d render').

Positive Prompt: "${positivePrompt}"

Respond with ONLY the comma-separated list of negative keywords.`;

        const payload = {
            contents: [{ role: "user", parts: [{ text: systemPrompt }] }]
        };

        try {
            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            const result = await response.json();
            const negativeText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

            if (negativeText) {
                return negativeText.trim();
            } else {
                throw new Error("Malformed API response for negative prompt.");
            }

        } catch (error) {
            console.error("Failed to generate negative prompt with API:", error);
            showToast("Falha ao gerar prompt negativo com IA. Usando padrão.", 4000, true);
            return generateNegativePrompt(promptData); // Fallback to the old static method
        }
    }

    async function generateAndDisplayManualPrompt() {
        goToStep(29);
        isFinalPromptGenerated = true;
        isEditingFromTechSheet = false;

        await new Promise(resolve => setTimeout(resolve, 0));
        
        const finalPromptTextarea = document.getElementById('finalPrompt');
        const negativePromptTextarea = document.getElementById('negativePrompt');
        
        finalPromptTextarea.value = "";
        negativePromptTextarea.value = "";
        
        loadingOverlay.classList.remove('hidden');
        loadingText.textContent = "Gerando prompt positivo...";

        const positivePrompt = buildInitialPrompt(false);
        finalPromptTextarea.value = positivePrompt;
        
        loadingText.textContent = "Gerando prompt negativo com IA...";

        const negativePrompt = await generateNegativePromptWithAPI(positivePrompt);
        negativePromptTextarea.value = negativePrompt;

        document.getElementById('consistencySeed').textContent = Math.floor(Math.random() * 999999999999999);
        
        loadingOverlay.classList.add('hidden');
        updateTechSheet();
    }

    // =================================================================================
    // Intelligent Auto-Prompt Generation Logic (API Driven)
    // =================================================================================
    async function handleAutoGenerate() {
        const userText = document.getElementById('autoPromptManual').value.trim();
        if (!userText) {
            showToast("Por favor, descreva sua ideia no campo de texto.", 3000, true);
            return;
        }

        loadingOverlay.classList.remove('hidden');
        loadingText.textContent = "Analisando sua ideia...";
        
        promptData = {};
        isFinalPromptGenerated = false;
        updateTechSheet();

        const systemPrompt = `Você é um engenheiro de prompt profissional para modelos avançados de IA de texto para imagem. Sua tarefa é pegar a ideia simples de um usuário, escrita em português, e expandi-la para um **prompt positivo** e um **prompt negativo** altamente detalhados e descritivos.

**Ideia do Usuário:** "${userText}"

**Instruções:**
1.  **Analise a Ideia:** Identifique os assuntos, ações, ambiente e estilo desejado.
2.  **Expanda o Prompt Positivo:** Elabore a ideia do usuário com detalhes ricos e evocativos. Inclua especificidades sobre:
    * **Assunto:** Aparência, roupas, expressão, pose.
    * **Estilo:** Estilo de arte (ex: fotorrealista, cinematográfico, anime, pintura a óleo), iluminação (ex: luz suave, neon, golden hour), composição (ex: close-up, plano geral, regra dos terços) e humor geral.
    * **Ambiente:** Fundo detalhado, clima, hora do dia.
    * **Qualidade:** Adicione termos que melhoram a qualidade da imagem (ex: obra-prima, 8k, ultra detalhado, foco nítido).
3.  **Crie o Prompt Negativo:** Gere uma lista de termos negativos comuns e termos específicos a serem evitados com base no prompt positivo. Inclua coisas como: deformado, má anatomia, feio, membros extras, marca d'água, borrado, texto, assinatura e estilos que contradizem o prompt positivo (ex: se o positivo é 'fotorrealista', o negativo deve incluir 'pintura, ilustração, desenho animado').
4.  **Formato de Saída:** Ambos os prompts devem estar em **inglês**. Retorne o resultado como um objeto JSON com a seguinte estrutura: \`{"positive_prompt": "...", "negative_prompt": "..."}\`.`;

        const payload = {
            contents: [{ role: "user", parts: [{ text: systemPrompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        "positive_prompt": { "type": "STRING" },
                        "negative_prompt": { "type": "STRING" }
                    },
                    required: ["positive_prompt", "negative_prompt"]
                }
            }
        };

        loadingText.textContent = "Gerando prompts detalhados...";
        
        try {
            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();
            const contentPart = result?.candidates?.[0]?.content?.parts?.[0];
            
            if (contentPart && contentPart.text) {
                const parsedJson = JSON.parse(contentPart.text);
                goToStep(29);
                document.getElementById('finalPrompt').value = parsedJson.positive_prompt || "Falha ao gerar o prompt positivo.";
                document.getElementById('negativePrompt').value = parsedJson.negative_prompt || "Falha ao gerar o prompt negativo.";
                document.getElementById('consistencySeed').textContent = Math.floor(Math.random() * 999999999999999);
                isFinalPromptGenerated = true;
                promptData['ai_generated'] = {label: `Baseado em: "${userText}"`, value: userText};
                updateTechSheet();
            } else {
                throw new Error("Resposta da API malformada ou vazia.");
            }

        } catch (error) {
            console.error("Falha na geração automática de prompt:", error);
            showToast("Ocorreu um erro ao gerar o prompt com a IA. Tente novamente.", 5000, true);
            goToStep(0); // Return to start
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    // =================================================================================
    // INITIALIZATION
    // =================================================================================
    document.addEventListener('DOMContentLoaded', () => {
        restart();
    });

    </script>
</body>
</html>
